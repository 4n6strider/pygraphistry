---
- group: name=www state=present
  sudo: yes

- user: name=www group=www
  sudo: yes

- apt: pkg={{ item }} state=installed
  sudo: yes
  with_items:
    - supervisor
    - npm
    - libxrandr-dev
    - libxcursor-dev
    - libglew-dev
    - libglu1-mesa-dev
    - libfreeimage-dev

- name: update graphistry repo
  git: repo=git@github.com:lmeyerov/graphistry.git dest=/opt/graphistry version=master update=yes
  
- name: graphistry config
  template: src=config.j2 dest=/opt/graphistry/experiments/nbody/naive/config.js

- name: update Superconductor repo
  git: repo=git@github.com:lmeyerov/Superconductor2.git dest=/opt/Superconductor2 version=master update=yes
  
- command: chown -R www:www /opt/Superconductor2
  sudo: yes
  
- command: chmod g+w -R /opt/Superconductor2
  sudo: yes

- command: chown -R www:www /opt/graphistry
  sudo: yes
  
- command: chmod g+w -R /opt/graphistry
  sudo: yes
  
# NPM
- command: mkdir /home/ubuntu/.npm_global
  ignore_errors: true
  
- command: chmod g+w -R /home/ubuntu/.npm_global

- command: npm config set prefix "/home/ubuntu/.npm_global"
- command: npm install --global grunt-cli
  sudo: yes

# AntTweakBar
# - command: chdir=/tmp/ wget -O 'AntTweakBar_116.zip' 'http://sourceforge.net/projects/anttweakbar/files/latest/download?source=dlp'
# - command: chdir=/tmp/ unzip AntTweakBar_116.zip
# - command: chdir=/tmp/AntTweakBar/src make
# - command: chdir=/tmp/AntTweakBar/src mv ../lib/libAntTweakBar.so /usr/lib/
#   sudo: yes
# - command: chdir=/tmp/AntTweakBar/src mv ../lib/libAntTweakBar.so.1 /usr/lib/
#   sudo: yes
# TODO: register changed and skip

# GLFW
# - git: repo=git@github.com:glfw/glfw.git dest=/opt/glfw version=master update=yes
# - command: chdir=/opt/glfw cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=TRUE
# - command: chdir=/opt/glfw make install
#   sudo: yes
# TODO: Try running the cmake command without `-DCMAKE_INSTALL_PREFIX=/usr`, so `cmake -G "Unix Makefiles"  -DBUILD_SHARED_LIBS=TRUE`. You'll need to manually move `libglfw.so` and its pkg-config file after, but it should work.

- command: npm install {{ item }} 
  with_items:
    - node-webcl
    - node-webgl

- command: chdir=/opt/Superconductor2/nodecl/compress npm install
- command: chdir=/opt/Superconductor2/nodecl/scproxy npm install
- command: chdir=/opt/Superconductor2/nodecl npm link ./compress
- command: chdir=/opt/Superconductor2/nodecl npm install
- command: chdir=/opt/Superconductor2/nodecl/GPUStreaming/StreamGL npm install
- command: chdir=/opt/Superconductor2/superconductorjs npm install
- command: chdir=/opt/graphistry/experiments/nbody/naive npm install
- command: chdir=/opt/graphistry/experiments/nbody/loader npm install

- name: node supervisor
  template: src=supervisor.j2 dest=/etc/supervisor/conf.d/node-server.conf
  sudo: yes
  notify: restart supervisor