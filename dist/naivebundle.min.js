!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Grapher=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){"use strict";var Q=_dereq_("Q");var glMatrix=_dereq_("gl-matrix");var events=_dereq_("./SimpleEvents.js");var _=_dereq_("underscore");var debug=_dereq_("debug")("N-body:main");var STEP_NUMBER_ON_CHANGE=30;var elementsPerPoint=2;function create(simulator,renderer,document,canvas,bgColor,dimensions,numSplits){dimensions=dimensions||[1,1];numSplits=numSplits||0;return renderer.create(document,canvas,bgColor,dimensions).then(function(rend){debug("Created renderer");return simulator.create(rend,dimensions,numSplits).then(function(sim){debug("Created simulator");var graph={renderer:rend,simulator:sim};graph.setPoints=setPoints.bind(this,graph);graph.setEdges=setEdges.bind(this,graph);graph.setPhysics=setPhysics.bind(this,graph);graph.setVisible=setVisible.bind(this,graph);graph.setLocked=setLocked.bind(this,graph);graph.setColorMap=setColorMap.bind(this,graph);graph.tick=tick.bind(this,graph);graph.stepNumber=0;graph.dimensions=dimensions;graph.numSplits=numSplits;return graph})})}function setPoints(graph,points){if(!(points instanceof Float32Array)){points=_toTypedArray(points,Float32Array)}graph.__pointsHostBuffer=points;graph.stepNumber=0;return graph.simulator.setPoints(points).then(function(){return graph})}var setEdges=Q.promised(function(graph,edges){if(edges.length<1)return Q.fcall(function(){return graph});if(!(edges instanceof Uint32Array)){edges=_toTypedArray(edges,Uint32Array)}debug("Number of edges: %d",edges.length/2);var edgesFlipped=new Uint32Array(edges.length);for(var i=0;i<edges.length;i++)edgesFlipped[i]=edges[edges.length-1-i];function encapsulate(edges){var edgeList=new Array(edges.length/2);for(var i=0;i<edges.length;i++)edgeList[i/2]=[edges[i],edges[i+1]];edgeList.sort(function(a,b){return a[0]<b[0]?-1:a[0]>b[0]?1:a[1]-b[1]});var workItems=[];var current_source=edgeList[0][0];var workItem=[0,1];edgeList.forEach(function(edge,i){if(i==0)return;if(edge[0]==current_source){workItem[1]++}else{workItems.push(workItem[0]);workItems.push(workItem[1]);current_source=edge[0];workItem=[i,1]}});workItems.push(workItem[0]);workItems.push(workItem[1]);workItems.sort(function(edgeList1,edgeList2){return edgeList1.length-edgeList2.length});var edgesFlattened=new Uint32Array(edges.length);for(var i=0;i<edgeList.length;i++){edgesFlattened[2*i]=edgeList[i][0];edgesFlattened[2*i+1]=edgeList[i][1]}return{edgesTyped:edgesFlattened,numWorkItems:workItems.length,workItemsTyped:new Uint32Array(workItems)}}var forwardEdges=encapsulate(edges);var backwardsEdges=encapsulate(edgesFlipped);var nDim=graph.dimensions.length;var midPoints=new Float32Array(edges.length/2*graph.numSplits*nDim||1);if(graph.numSplits){for(var i=0;i<edges.length;i+=2){var src=edges[i];var dst=edges[i+1];for(var d=0;d<nDim;d++){var start=graph.__pointsHostBuffer[src*nDim+d];var end=graph.__pointsHostBuffer[dst*nDim+d];var step=(end-start)/(graph.numSplits+1);for(var q=0;q<graph.numSplits;q++){midPoints[(i*graph.numSplits+q)*nDim+d]=start+step*(q+1)}}}}debug("Number of control points, splits: %d, %d",edges.length*graph.numSplits,graph.numSplits);return graph.simulator.setEdges(forwardEdges,backwardsEdges,midPoints).then(function(){return graph})});function setPhysics(graph,opts){graph.stepNumber=STEP_NUMBER_ON_CHANGE;graph.simulator.setPhysics(opts)}function setVisible(graph,opts){graph.renderer.setVisible(opts)}function setLocked(graph,opts){graph.simulator.setLocked(opts)}function setColorMap(graph,imageURL,maybeClusters){return graph.renderer.setColorMap(imageURL,maybeClusters).then(_.constant(graph))}function _toTypedArray(array,cons){var floats=new cons(array.length*elementsPerPoint);for(var i=0;i<array.length;i++){var ii=i*elementsPerPoint;floats[ii+0]=array[i][0];floats[ii+1]=array[i][1]}return floats}function tick(graph){events.fire("tickBegin");events.fire("simulateBegin");return graph.simulator.tick(graph.stepNumber++).then(function(){events.fire("simulateEnd");events.fire("renderBegin");return graph.renderer.render()}).then(function(){events.fire("renderEnd");events.fire("tickEnd");return graph})}module.exports={elementsPerPoint:elementsPerPoint,create:create,setPoints:setPoints,setEdges:setEdges,setColorMap:setColorMap,tick:tick}},{"./SimpleEvents.js":4,Q:13,debug:14,"gl-matrix":17,underscore:19}],2:[function(_dereq_,module,exports){"use strict";var Q=_dereq_("Q");var glMatrix=_dereq_("gl-matrix");var util=_dereq_("./util.js");var debug=_dereq_("debug")("N-body:RenderGL");var create=Q.promised(function(document,canvas,bgColor,dimensions,visible){visible=visible||{};var renderer={document:document,canvas:canvas};canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight;var gl=canvas.getContext("webgl",{antialias:true,premultipliedAlpha:false});if(gl===null){throw new Error("Could not initialize WebGL")}gl.enable(gl.BLEND);gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE);gl.blendEquationSeparate(gl.FUNC_ADD,gl.FUNC_ADD);gl.depthFunc(gl.LEQUAL);gl.enable(gl.DEPTH_TEST);gl.clearColor.apply(gl,bgColor);gl.lineWidth(1);renderer.gl=gl;renderer.canvas=canvas;renderer.buffers={curPoints:null,springs:null,curMidPoints:null,midSprings:null,midSpringsColorCoord:null};Object.seal(renderer.buffers);renderer.programs={points:null,edges:null,midpoints:null,midedges:null,midedgestextured:null};Object.seal(renderer.programs);renderer.elementsPerPoint=2;renderer.numPoints=0;renderer.numEdges=0;renderer.numMidPoints=0;renderer.numMidEdges=0;renderer.colorTexture=null;renderer.setCamera2d=setCamera2d.bind(this,renderer);renderer.createBuffer=createBuffer.bind(this,renderer);renderer.render=render.bind(this,renderer);renderer.createProgram=createProgram.bind(this,renderer);renderer.setVisible=setVisible.bind(this,renderer);renderer.isVisible=isVisible.bind(this,renderer);renderer.setColorMap=setColorMap.bind(this,renderer);renderer.visible={points:true,edges:true,midpoints:false,midedges:false};renderer.setVisible(visible);return Q.all(["point","edge","midpoint","midedge","midedge-textured"].map(function(name){return renderer.createProgram(name+".vertex",name+".fragment")})).spread(function(pointProgram,edgeProgram,midpointProgram,midedgeProgram,midedgeTexturedProgram){renderer.programs["points"]=pointProgram;renderer.programs["edges"]=edgeProgram;renderer.programs["midpoints"]=midpointProgram;renderer.programs["midedges"]=midedgeProgram;renderer.programs["midedgestextured"]=midedgeTexturedProgram;return renderer.setCamera2d(-.01,dimensions[0]+.01,-.01,dimensions[1]+.01)}).then(function(renderer){Object.seal(renderer);return renderer})});function createProgram(renderer,vertexShaderID,fragmentShaderID){var gl=renderer.gl;var pragObj={};pragObj.renderer=renderer;pragObj.glProgram=gl.createProgram();pragObj.bindVertexAttrib=bindVertexAttrib.bind(this,pragObj);pragObj.use=function(){gl.useProgram(pragObj.glProgram)};pragObj.attributes={};return Q.all([util.getSource(vertexShaderID+".glsl"),util.getSource(fragmentShaderID+".glsl")]).spread(function(vertShaderSource,fragShaderSource){function compileShader(program,shaderSource,shaderType){var sanitizedShaderSource=shaderSource.replace(/(precision [a-z]* float;)/g,"#ifdef GL_ES\n$1\n#endif\n");var shader=renderer.gl.createShader(shaderType);renderer.gl.shaderSource(shader,sanitizedShaderSource);renderer.gl.compileShader(shader);if(!renderer.gl.getShaderParameter(shader,renderer.gl.COMPILE_STATUS)){throw new Error("Error compiling WebGL shader (shader type: "+shaderType+")")}if(!renderer.gl.isShader(shader)){throw new Error("After compiling shader, WebGL is reporting it is not valid")}renderer.gl.attachShader(program.glProgram,shader);return shader}pragObj.vertexShader=compileShader(pragObj,vertShaderSource,gl.VERTEX_SHADER);pragObj.fragmentShader=compileShader(pragObj,fragShaderSource,gl.FRAGMENT_SHADER);gl.linkProgram(pragObj.glProgram);return pragObj})}var setCamera2d=Q.promised(function(renderer,left,right,bottom,top){renderer.gl.viewport(0,0,renderer.canvas.width,renderer.canvas.height);var lr=1/(left-right),bt=1/(bottom-top);var mvpMatrix=glMatrix.mat2d.create();glMatrix.mat2d.scale(mvpMatrix,mvpMatrix,glMatrix.vec2.fromValues(-2*lr,-2*bt));glMatrix.mat2d.translate(mvpMatrix,mvpMatrix,glMatrix.vec2.fromValues((left+right)*lr,(top+bottom)*bt));var mvpMat3=glMatrix.mat3.create();glMatrix.mat3.fromMat2d(mvpMat3,mvpMatrix);["points","edges","midpoints","midedges","midedgestextured"].forEach(function(name){var program=renderer.programs[name].glProgram;renderer.gl.useProgram(program);var mvpLocation=renderer.gl.getUniformLocation(program,"mvp");renderer.gl.uniformMatrix3fv(mvpLocation,false,mvpMat3)});return renderer});var colorMaps=[[[0,0,0]],[[255,0,0],[0,0,255]],[[141,211,199],[255,255,179],[190,186,218]],[[141,211,199],[255,255,179],[190,186,218],[251,128,114]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0],[255,255,51]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0],[255,255,51],[166,86,40]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0],[255,255,51],[166,86,40],[247,129,191]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0],[255,255,51],[166,86,40],[247,129,191],[153,153,153]],[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154]],[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154],[255,255,153]],[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154],[255,255,153],[177,89,40]]];var setColorMap=Q.promised(function(renderer,imageURL,maybeClusters){var gl=renderer.gl;return util.getImage(imageURL).then(function(texImg){var imageData;try{if(typeof window=="undefined"){debug("FIXME: no fancy setColorMap in node")}else if(maybeClusters){debug("Clustering colors");var canvas=renderer.document.createElement("canvas");canvas.width=texImg.width;canvas.height=texImg.height;var ctx=canvas.getContext("2d");if(ctx.createImageData){imageData=ctx.createImageData(texImg.width,texImg.height)}else{imageData={data:new Uint8Array(texImg.width*texImg.height*4)}}for(var x=0;x<texImg.width;x++){for(var y=0;y<texImg.height;y++){var i=4*(y*texImg.width+x);imageData.data[i]=255;imageData.data[i+1]=255;imageData.data[i+2]=255;imageData.data[i+3]=0}}var colors=colorMaps[maybeClusters.clusters.centers.length-1];maybeClusters.edges.forEach(function(pair,i){var clusterIdx=maybeClusters.clusters.labeling[i];var cluster=maybeClusters.clusters.centers[clusterIdx];var startPoint=maybeClusters.points[pair[0]];var color=colors[clusterIdx];var col=startPoint[0]*texImg.width;var row=startPoint[1]*texImg.height;var range=3;for(var a=-range;a<range;a++){for(var b=-range;b<range;b++){var idx=(Math.floor(row+a)*texImg.width+Math.floor(col+b))*4;idx=Math.max(0,Math.min(texImg.width*texImg.height*4,idx));imageData.data[idx]=color[0];imageData.data[idx+1]=color[1];imageData.data[idx+2]=color[2];imageData.data[idx+3]=255}}})}else{debug("Using preset colors from %s",imageURL)}}catch(e){console.error("bad cluster load",e,e.stack);throw e}renderer.colorTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,renderer.colorTexture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,imageData?imageData:texImg);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);debug("Finished setting colormap")})});var createBuffer=Q.promised(function(renderer,data){debug("Creating gl buffer of type %s. Constructor: %o",typeof data,data.constructor);var buffer=renderer.gl.createBuffer();var bufObj={buffer:buffer,gl:renderer.gl,len:typeof data==="number"?data:data.byteLength};bufObj.delete=Q.promised(function(){renderer.gl.deleteBuffer(buffer);return renderer});bufObj.write=write.bind(this,bufObj);if(data){return bufObj.write(data)}else{return bufObj}});var write=Q.promised(function(buffer,data){buffer.gl.bindBuffer(buffer.gl.ARRAY_BUFFER,buffer.buffer);buffer.gl.bufferData(buffer.gl.ARRAY_BUFFER,data,buffer.gl.DYNAMIC_DRAW);buffer.gl.finish();return buffer});function bindVertexAttrib(program,buffer,attribute,elementsPerItem,glType,normalize,stride,offset){var gl=program.renderer.gl;var location=gl.getAttribLocation(program.glProgram,attribute);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.buffer);gl.enableVertexAttribArray(location);gl.vertexAttribPointer(location,elementsPerItem,glType,normalize,stride,offset);return program}function setVisible(renderer,visible){util.extend(renderer.visible,visible);return renderer}function isVisible(renderer,element){return renderer.visible[element]||false}var render=Q.promised(function(renderer){var gl=renderer.gl;gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);if(renderer.numPoints<1){return renderer}if(renderer.numEdges>0){if(renderer.isVisible("edges")){renderer.programs["edges"].use();renderer.programs["edges"].bindVertexAttrib(renderer.buffers.springs,"curPos",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);gl.drawArrays(gl.LINES,0,renderer.numEdges*2)}if(renderer.isVisible("midedges")){if(renderer.colorTexture===null){renderer.programs["midedges"].use();renderer.programs["midedges"].bindVertexAttrib(renderer.buffers.midSprings,"curPos",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);gl.drawArrays(gl.LINES,0,renderer.numMidEdges*2)}else{renderer.programs["midedgestextured"].use();renderer.programs["midedgestextured"].bindVertexAttrib(renderer.buffers.midSprings,"curPos",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);renderer.programs["midedgestextured"].bindVertexAttrib(renderer.buffers.midSpringsColorCoord,"aColorCoord",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,renderer.colorTexture);gl.uniform1i(gl.getUniformLocation(renderer.programs["midedgestextured"].glProgram,"uSampler"),0);gl.drawArrays(gl.LINES,0,renderer.numMidEdges*2)}}}if(renderer.isVisible("points")){renderer.programs["points"].use();renderer.programs["points"].bindVertexAttrib(renderer.buffers.curPoints,"curPos",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);gl.drawArrays(gl.POINTS,0,renderer.numPoints)}if(renderer.isVisible("midpoints")){renderer.programs["midpoints"].use();renderer.programs["midpoints"].bindVertexAttrib(renderer.buffers.curMidPoints,"curPos",renderer.elementsPerPoint,gl.FLOAT,false,renderer.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,0);gl.drawArrays(gl.POINTS,0,renderer.numMidPoints)}gl.finish();return renderer});module.exports={create:create,createProgram:createProgram,setColorMap:setColorMap,setCamera2d:setCamera2d,createBuffer:createBuffer,write:write,bindVertexAttrib:bindVertexAttrib,setVisible:setVisible,isVisible:isVisible,render:render}},{"./util.js":12,Q:13,debug:14,"gl-matrix":17}],3:[function(_dereq_,module,exports){"use strict";var Q=_dereq_("Q");var util=_dereq_("./util.js");var cljs=_dereq_("./cl.js");var _=_dereq_("underscore");var debug=_dereq_("debug")("N-body:SimCL");if(typeof window=="undefined"){var webcl=_dereq_("node-webcl")}else if(typeof webcl=="undefined"){var webcl=window.webcl}Q.longStackSupport=true;var randLength=73;function create(renderer,dimensions,numSplits,locked){return cljs.create(renderer.gl).then(function(cl){debug("Creating CL object with GL context");return util.getSource("apply-forces.cl").then(function(source){debug("Retrieved kernel source");return cl.compile(source,["apply_points","apply_springs","apply_midpoints","apply_midsprings"])}).then(function(kernels){debug("Compiled kernel source");var simObj={renderer:renderer,cl:cl,pointKernel:kernels["apply_points"],edgesKernel:kernels["apply_springs"],midPointKernel:kernels["apply_midpoints"],midEdgesKernel:kernels["apply_midsprings"],elementsPerPoint:2};simObj.tick=tick.bind(this,simObj);simObj.setPoints=setPoints.bind(this,simObj);simObj.setEdges=setEdges.bind(this,simObj);simObj.setLocked=setLocked.bind(this,simObj);simObj.setPhysics=setPhysics.bind(this,simObj);simObj.resetBuffers=resetBuffers.bind(this,simObj);simObj.dimensions=dimensions;simObj.numSplits=numSplits;simObj.numPoints=0;simObj.numEdges=0;simObj.numForwardsWorkItems=0;simObj.numBackwardsWorkItems=0;simObj.numMidPoints=0;simObj.numMidEdges=0;simObj.locked=util.extend({lockPoints:false,lockMidpoints:true,lockEdges:false,lockMidedges:true},locked||{});simObj.buffers={nextPoints:null,randValues:null,curPoints:null,forwardsEdges:null,forwardsWorkItems:null,backwardsEdges:null,backwardsWorkItems:null,springsPos:null,midSpringsPos:null,midSpringsColorCoord:null,nextMidPoints:null,curMidPoints:null};Object.seal(simObj.buffers);debug("WebCL simulator created");Object.seal(simObj);return simObj},function(err){console.error("Could not compile sim",err)})})}var resetBuffers=function(simulator,buffers){var validBuffers=buffers.filter(function(val){return!!val});if(validBuffers.length==0){return Q(null)}validBuffers.forEach(function(buffToDelete){for(var buff in simulator.buffers){if(simulator.buffers.hasOwnProperty(buff)&&simulator.buffers[buff]==buffToDelete){simulator.buffers[buff]=null}}});validBuffers.forEach(function(buffToDelete){buffToDelete.delete()})};function setPoints(simulator,points){if(points.length<1){throw new Error("The points buffer is empty")}if(points.length%simulator.elementsPerPoint!==0){throw new Error("The points buffer is an invalid size (must be a multiple of "+simulator.elementsPerPoint+")")}simulator.resetBuffers([simulator.buffers.nextPoints,simulator.buffers.randValues,simulator.buffers.curPoints]);simulator.numPoints=points.length/simulator.elementsPerPoint;simulator.renderer.numPoints=simulator.numPoints;debug("Number of points in simulation: %d",simulator.renderer.numPoints);return Q.all([simulator.renderer.createBuffer(points,"curPoints"),simulator.cl.createBuffer(points.byteLength,"nextPoints"),simulator.cl.createBuffer(randLength*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,"randValues")]).spread(function(pointsVBO,nextPointsBuffer,randBuffer){debug("Created most of the points");simulator.buffers.nextPoints=nextPointsBuffer;simulator.renderer.buffers.curPoints=pointsVBO;simulator.buffers.randValues=randBuffer;var rands=new Float32Array(randLength*simulator.elementsPerPoint);for(var i=0;i<rands.length;i++){rands[i]=Math.random()}return Q.all([simulator.cl.createBufferGL(pointsVBO,"curPoints"),simulator.buffers.randValues.write(rands)])}).spread(function(pointsBuf,randValues){simulator.buffers.curPoints=pointsBuf;var localPosSize=Math.min(simulator.cl.maxThreads,simulator.numPoints)*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT;debug("Setting point 0. FIXME: dyn alloc __local, not hardcode in kernel");simulator.pointKernel.setArgs([webcl.type?[simulator.numPoints]:new Uint32Array([simulator.numPoints]),simulator.buffers.curPoints.buffer,simulator.buffers.nextPoints.buffer,webcl.type?[1]:new Uint32Array([localPosSize]),webcl.type?[simulator.dimensions[0]]:new Float32Array([simulator.dimensions[0]]),webcl.type?[simulator.dimensions[1]]:new Float32Array([simulator.dimensions[1]]),webcl.type?[-1e-5]:new Float32Array([-1e-5]),webcl.type?[.2]:new Float32Array([.2]),simulator.buffers.randValues.buffer,webcl.type?[0]:new Uint32Array([0])],webcl.type?[webcl.type.UINT,null,null,webcl.type.LOCAL_MEMORY_SIZE,webcl.type.FLOAT,webcl.type.FLOAT,webcl.type.FLOAT,webcl.type.FLOAT,null,webcl.type.UINT]:undefined);return simulator})}function setEdges(simulator,forwardsEdges,backwardsEdges,midPoints){var elementsPerEdge=2;var elementsPerWorkItem=2;if(forwardsEdges.edgesTyped.length<1){throw new Error("The edge buffer is empty")}if(forwardsEdges.edgesTyped.length%elementsPerEdge!==0){throw new Error("The edge buffer size is invalid (must be a multiple of "+elementsPerEdge+")")}if(forwardsEdges.workItemsTyped.length<1){throw new Error("The work items buffer is empty")}if(forwardsEdges.workItemsTyped.length%elementsPerWorkItem!==0){throw new Error("The work item buffer size is invalid (must be a multiple of "+elementsPerWorkItem+")")}simulator.resetBuffers([simulator.buffers.forwardsEdges,simulator.buffers.forwardsWorkItems,simulator.buffers.backwardsEdges,simulator.buffers.backwardsWorkItems,simulator.buffers.springsPos,simulator.buffers.midSpringsPos,simulator.buffers.midSpringsColorCoord]);return Q().then(function(){simulator.numEdges=forwardsEdges.edgesTyped.length/elementsPerEdge;simulator.renderer.numEdges=simulator.numEdges;simulator.numForwardsWorkItems=forwardsEdges.workItemsTyped.length/elementsPerWorkItem;simulator.numBackwardsWorkItems=backwardsEdges.workItemsTyped.length/elementsPerWorkItem;simulator.numMidPoints=midPoints.length/simulator.elementsPerPoint;simulator.renderer.numMidPoints=simulator.numMidPoints;simulator.numMidEdges=simulator.numMidPoints+simulator.numEdges;simulator.renderer.numMidEdges=simulator.numMidEdges;return Q.all([simulator.cl.createBuffer(forwardsEdges.edgesTyped.byteLength,"forwardsEdges"),simulator.cl.createBuffer(forwardsEdges.workItemsTyped.byteLength,"forwardsWorkItems"),simulator.cl.createBuffer(backwardsEdges.edgesTyped.byteLength,"backwardsEdges"),simulator.cl.createBuffer(backwardsEdges.workItemsTyped.byteLength,"backwardsWorkItems"),simulator.cl.createBuffer(midPoints.byteLength,"nextMidPoints"),simulator.renderer.createBuffer(simulator.numEdges*elementsPerEdge*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,"springs"),simulator.renderer.createBuffer(midPoints,"curMidPoints"),simulator.renderer.createBuffer(simulator.numMidEdges*elementsPerEdge*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,"midSprings"),simulator.renderer.createBuffer(simulator.numMidEdges*elementsPerEdge*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT,"midSpringsColorCoord")])}).spread(function(forwardsEdgesBuffer,forwardsWorkItemsBuffer,backwardsEdgesBuffer,backwardsWorkItemsBuffer,nextMidPointsBuffer,springsVBO,midPointsVBO,midSpringsVBO,midSpringsColorCoordVBO){simulator.buffers.forwardsEdges=forwardsEdgesBuffer;simulator.buffers.forwardsWorkItems=forwardsWorkItemsBuffer;simulator.buffers.backwardsEdges=backwardsEdgesBuffer;simulator.buffers.backwardsWorkItems=backwardsWorkItemsBuffer;simulator.buffers.nextMidPoints=nextMidPointsBuffer;simulator.renderer.buffers.springs=springsVBO;simulator.renderer.buffers.curMidPoints=midPointsVBO;simulator.renderer.buffers.midSprings=midSpringsVBO;simulator.renderer.buffers.midSpringsColorCoord=midSpringsColorCoordVBO;return Q.all([simulator.cl.createBufferGL(springsVBO,"springsPos"),simulator.cl.createBufferGL(midPointsVBO,"curMidPoints"),simulator.cl.createBufferGL(midSpringsVBO,"midSpringsPos"),simulator.cl.createBufferGL(midSpringsColorCoordVBO,"midSpringsColorCoord"),simulator.buffers.forwardsEdges.write(forwardsEdges.edgesTyped),simulator.buffers.forwardsWorkItems.write(forwardsEdges.workItemsTyped),simulator.buffers.backwardsEdges.write(backwardsEdges.edgesTyped),simulator.buffers.backwardsWorkItems.write(backwardsEdges.workItemsTyped)])}).spread(function(springsBuffer,midPointsBuf,midSpringsBuffer,midSpringsColorCoordBuffer){simulator.buffers.springsPos=springsBuffer;simulator.buffers.midSpringsPos=midSpringsBuffer;simulator.buffers.curMidPoints=midPointsBuf;simulator.buffers.midSpringsColorCoord=midSpringsColorCoordBuffer;var localPosSize=Math.min(simulator.cl.maxThreads,simulator.numMidPoints)*simulator.elementsPerPoint*Float32Array.BYTES_PER_ELEMENT;simulator.midPointKernel.setArgs([webcl.type?[simulator.numMidPoints]:new Uint32Array([simulator.numMidPoints]),webcl.type?[simulator.numSplits]:new Uint32Array([simulator.numSplits]),simulator.buffers.curMidPoints.buffer,simulator.buffers.nextMidPoints.buffer,webcl.type?[localPosSize]:new Uint32Array([localPosSize]),webcl.type?[simulator.dimensions[0]]:new Float32Array([simulator.dimensions[0]]),webcl.type?[simulator.dimensions[1]]:new Float32Array([simulator.dimensions[1]]),webcl.type?[-1e-5]:new Float32Array([-1e-5]),webcl.type?[.2]:new Float32Array([.2]),simulator.buffers.randValues.buffer,webcl.type?[0]:new Uint32Array([0])],webcl.type?[webcl.type.UINT,webcl.type.UINT,null,null,webcl.type.LOCAL_MEMORY_SIZE,webcl.type.FLOAT,webcl.type.FLOAT,webcl.type.FLOAT,webcl.type.FLOAT,null,webcl.type.UINT]:null);simulator.edgesKernel.setArgs([null,null,null,null,simulator.buffers.springsPos.buffer,webcl.type?[1]:new Float32Array([1]),webcl.type?[.1]:new Float32Array([.1]),null],webcl.type?[null,null,null,null,null,webcl.type.FLOAT,webcl.type.FLOAT]:null);simulator.midEdgesKernel.setArgs([webcl.type?[simulator.numSplits]:new Uint32Array([simulator.numSplits]),simulator.buffers.forwardsEdges.buffer,simulator.buffers.forwardsWorkItems.buffer,simulator.buffers.curPoints.buffer,simulator.buffers.nextMidPoints.buffer,simulator.buffers.curMidPoints.buffer,simulator.buffers.midSpringsPos.buffer,simulator.buffers.midSpringsColorCoord.buffer,webcl.type?[1]:new Float32Array([1]),webcl.type?[.1]:new Float32Array([.1]),null],webcl.type?[webcl.type.UINT,null,null,null,null,null,null,null,webcl.type.FLOAT,webcl.type.FLOAT,null]:null);return simulator}).then(_.identity,function(err){console.error("bad set edges",err);console.error(err.stack)})}function setLocked(simulator,cfg){cfg=cfg||{};util.extend(simulator.locked,cfg)}var totCfg={};function setPhysics(simulator,cfg){cfg=cfg||{};for(var i in cfg){totCfg[i]=cfg[i]}debug("Updating simulation physics to %o (new: %o)",totCfg,cfg);if(cfg.charge||cfg.gravity){var charge=cfg.charge?webcl.type?[cfg.charge]:new Float32Array([cfg.charge]):null;var charge_t=cfg.charge?cljs.types.float_t:null;var gravity=cfg.gravity?webcl.type?[cfg.gravity]:new Float32Array([cfg.gravity]):null;var gravity_t=cfg.gravity?cljs.types.float_t:null;simulator.pointKernel.setArgs([null,null,null,null,null,null,charge,gravity,null,null],[null,null,null,null,null,null,charge_t,gravity_t,null,null]);simulator.midPointKernel.setArgs([null,null,null,null,null,null,null,charge,gravity,null,null],[null,null,null,null,null,null,null,charge_t,gravity_t,null,null])}if(cfg.edgeDistance||cfg.edgeStrength){var edgeDistance=cfg.edgeDistance?webcl.type?[cfg.edgeDistance]:new Float32Array([cfg.edgeDistance]):null;var edgeDistance_t=cfg.edgeDistance?cljs.types.float_t:null;var edgeStrength=cfg.edgeStrength?webcl.type?[cfg.edgeStrength]:new Float32Array([cfg.edgeStrength]):null;var edgeStrength_t=cfg.edgeStrength?cljs.types.float_t:null;simulator.edgesKernel.setArgs([null,null,null,null,null,edgeStrength,edgeDistance,null],[null,null,null,null,null,edgeStrength_t,edgeDistance_t,null]);simulator.midEdgesKernel.setArgs([null,null,null,null,null,null,null,null,edgeStrength,edgeDistance,null],[null,null,null,null,null,null,null,null,edgeStrength_t,edgeDistance_t,null])}}function tick(simulator,stepNumber){var edgeKernelSeq=function(edges,workItems,numWorkItems,fromPoints,toPoints){var resources=[edges,workItems,fromPoints,toPoints,simulator.buffers.springsPos];simulator.edgesKernel.setArgs([edges.buffer,workItems.buffer,fromPoints.buffer,toPoints.buffer,null,null,null,webcl.type?[stepNumber]:new Uint32Array([stepNumber])],webcl.type?[null,null,null,null,null,null,null,cljs.types.uint_t]:null);return simulator.edgesKernel.call(numWorkItems,resources)};if(simulator.numPoints<1){return Q(simulator)}return Q().then(function(){if(simulator.locked.lockPoints){return}else{var resources=[simulator.buffers.curPoints,simulator.buffers.nextPoints,simulator.buffers.randValues];simulator.pointKernel.setArgs([null,null,null,null,null,null,null,null,null,webcl.type?[stepNumber]:new Uint32Array([stepNumber])],[null,null,null,null,null,null,null,null,null,cljs.types.uint_t]);return simulator.pointKernel.call(simulator.numPoints,resources).then(function(){return simulator.buffers.nextPoints.copyInto(simulator.buffers.curPoints)})}}).then(function(){if(simulator.numEdges<=0||simulator.locked.lockEdges){return simulator}if(simulator.numEdges>0){return edgeKernelSeq(simulator.buffers.forwardsEdges,simulator.buffers.forwardsWorkItems,simulator.numForwardsWorkItems,simulator.buffers.curPoints,simulator.buffers.nextPoints).then(function(){return edgeKernelSeq(simulator.buffers.backwardsEdges,simulator.buffers.backwardsWorkItems,simulator.numBackwardsWorkItems,simulator.buffers.nextPoints,simulator.buffers.curPoints)})}}).then(function(){if(simulator.locked.lockMidpoints){return simulator.buffers.curMidPoints.copyInto(simulator.buffers.nextMidPoints)}else{var resources=[simulator.buffers.curMidPoints,simulator.buffers.nextMidPoints,simulator.buffers.midSpringsColorCoord];simulator.midPointKernel.setArgs([null,null,null,null,null,null,null,null,null,null,webcl.type?[stepNumber]:new Uint32Array([stepNumber])],[null,null,null,null,null,null,null,null,null,null,cljs.types.uint_t]);return simulator.midPointKernel.call(simulator.numMidPoints,resources)}}).then(function(){if(simulator.numEdges>0&&!simulator.locked.lockMidedges){var resources=[simulator.buffers.forwardsEdges,simulator.buffers.forwardsWorkItems,simulator.buffers.curPoints,simulator.buffers.nextMidPoints,simulator.buffers.curMidPoints,simulator.buffers.midSpringsPos,simulator.buffers.midSpringsColorCoord];simulator.midEdgesKernel.setArgs([null,null,null,null,null,null,null,null,null,null,webcl.type?[stepNumber]:new Uint32Array([stepNumber])],[null,null,null,null,null,null,null,null,null,null,cljs.types.uint_t]);return simulator.midEdgesKernel.call(simulator.numForwardsWorkItems,resources)}else{return simulator.buffers.nextMidPoints.copyInto(simulator.buffers.curMidPoints)}}).then(function(){simulator.cl.queue.finish();simulator.renderer.gl.finish()})}module.exports={create:create,setLocked:setLocked,setPoints:setPoints,setEdges:setEdges,tick:tick}},{"./cl.js":5,"./util.js":12,Q:13,debug:14,"node-webcl":"fWqvvE",underscore:19}],4:[function(_dereq_,module,exports){"use strict";var exports={};var listeners={};exports.listen=function(event,callback){var eventListeners=listeners[event]||[];eventListeners.push(callback);listeners[event]=eventListeners};exports.fire=function(event,args){var eventListeners=listeners[event]||[];for(var i in eventListeners){eventListeners[i].call(this,args)}};module.exports=exports},{}],5:[function(_dereq_,module,exports){"use strict";var Q=_dereq_("q");var events=_dereq_("./SimpleEvents.js");var _=_dereq_("underscore");var debug=_dereq_("debug")("N-body:cl");if(typeof window=="undefined"){var webcl=_dereq_("node-webcl");console.debug=console.log}else if(typeof webcl=="undefined"){var webcl=window.webcl}var DEVICE_TYPE=webcl.DEVICE_TYPE_GPU;var getClContext;if(typeof window=="undefined"){debug("Node.js cl.js initializing");var createContext=function(webcl,gl,platform,devices){return webcl.createContext({devices:devices,shareGroup:gl,platform:platform})};var createCL=function(webcl,gl){if(typeof webcl==="undefined"){throw new Error("WebCL does not appear to be supported in your browser")
}else if(webcl===null){throw new Error("Can't access WebCL object")}var platforms=webcl.getPlatforms();if(platforms.length===0){throw new Error("Can't find any WebCL platforms")}var platform=platforms[0];var devices=platform.getDevices(DEVICE_TYPE).map(function(d){var workItems=d.getInfo(webcl.DEVICE_MAX_WORK_ITEM_SIZES);return{device:d,computeUnits:workItems.reduce(function(a,b){return a*b})}});devices.sort(function(a,b){var nameA=a.device.getInfo(webcl.DEVICE_VENDOR);var nameB=b.device.getInfo(webcl.DEVICE_VENDOR);var vendor="NVIDIA";if(nameA.indexOf(vendor)!=-1&&nameB.indexOf(vendor)==-1){return-1}else if(nameB.indexOf(vendor)!=-1&&nameA.indexOf(vendor)==-1){return 1}else{return b.computeUnits-a.computeUnits}});var deviceWrapper;var err=devices.length?null:new Error("No WebCL devices of specified type ("+DEVICE_TYPE+") found");for(var i=0;i<devices.length;i++){var wrapped=devices[i];try{if(wrapped.device.getInfo(webcl.DEVICE_EXTENSIONS).search(/gl.sharing/i)==-1){debug("Skipping device %d due to no sharing. %o",i,wrapped);continue}wrapped.context=createContext(webcl,gl,platform,[wrapped.device]);if(wrapped.context===null){throw new Error("Error creating WebCL context")}wrapped.queue=wrapped.context.createCommandQueue(wrapped.device,0)}catch(e){debug("Skipping device %d due to error %o. %o",i,e,wrapped);err=e;continue}deviceWrapper=wrapped;break}if(!deviceWrapper){throw err}debug("Device set. Vendor: %s. Device: %o",deviceWrapper.device.getInfo(webcl.DEVICE_VENDOR),deviceWrapper);var res={gl:gl,cl:webcl,context:deviceWrapper.context,device:deviceWrapper.device,queue:deviceWrapper.queue,maxThreads:deviceWrapper.device.getInfo(webcl.DEVICE_MAX_WORK_GROUP_SIZE),numCores:deviceWrapper.device.getInfo(webcl.DEVICE_MAX_COMPUTE_UNITS)};res.compile=compile.bind(this,res);res.createBuffer=createBuffer.bind(this,res);res.createBufferGL=createBufferGL.bind(this,res);return res};getClContext=function(gl){return createCL(webcl,gl)}}else{getClContext=function(gl){if(typeof webcl==="undefined"){throw new Error("WebCL does not appear to be supported in your browser")}var cl=webcl;if(cl===null){throw new Error("Can't access WebCL object")}var platforms=cl.getPlatforms();if(platforms.length===0){throw new Error("Can't find any WebCL platforms")}var platform=platforms[0];var devices=platform.getDevices(DEVICE_TYPE).map(function(d){function typeToString(v){return v===2?"CPU":v===4?"GPU":v===8?"ACCELERATOR":"unknown type: "+v}var workItems=d.getInfo(cl.DEVICE_MAX_WORK_ITEM_SIZES);return{device:d,DEVICE_TYPE:typeToString(d.getInfo(cl.DEVICE_TYPE)),DEVICE_MAX_WORK_ITEM_SIZES:workItems,computeUnits:[].slice.call(workItems,0).reduce(function(a,b){return a*b})}});devices.sort(function(a,b){return b.computeUnits-a.computeUnits});var deviceWrapper;var err=devices.length?null:new Error("No WebCL devices of specified type ("+DEVICE_TYPE+") found");for(var i=0;i<devices.length;i++){var wrapped=devices[i];try{wrapped.context=_createContext(cl,gl,platform,[wrapped.device]);if(wrapped.context===null){throw new Error("Error creating WebCL context")}wrapped.queue=wrapped.context.createCommandQueue(wrapped.device,null)}catch(e){debug("Skipping device %d due to error %o. %o",i,e,wrapped);err=e;continue}deviceWrapper=wrapped;break}if(!deviceWrapper){throw err}debug("Device set. Device: %o",deviceWrapper);var clObj={gl:gl,cl:cl,context:deviceWrapper.context,device:deviceWrapper.device,queue:deviceWrapper.queue,maxThreads:deviceWrapper.device.getInfo(cl.DEVICE_MAX_WORK_GROUP_SIZE),numCores:deviceWrapper.device.getInfo(cl.DEVICE_MAX_COMPUTE_UNITS)};clObj.compile=compile.bind(this,clObj);clObj.createBuffer=createBuffer.bind(this,clObj);clObj.createBufferGL=createBufferGL.bind(this,clObj);return clObj}}var create=Q.promised(getClContext);var _createContext=function(cl,gl,platform,devices){cl.enableExtension("KHR_GL_SHARING");return cl.createContext(gl,devices)};var compile=Q.promised(function(cl,source,kernels){var t0=(new Date).getTime();debug("Compiling kernels");try{var program=cl.context.createProgram("#define NODECL\n\n"+source);program.build([cl.device]);if(typeof kernels==="string"){var kernelObj={};kernelObj.name=undefined;kernelObj.kernel=program.createKernel(kernels);kernelObj.cl=cl;kernelObj.call=call.bind(this,kernelObj);kernelObj.setArgs=setArgs.bind(this,kernelObj);return kernelObj}else{var kernelObjs={};for(var i=0;i<kernels.length;i++){var kernelName=kernels[i];var kernelObj={};kernelObj.name=kernelName;kernelObj.kernel=program.createKernel(kernelName);kernelObj.cl=cl;kernelObj.call=call.bind(this,kernelObj);kernelObj.setArgs=setArgs.bind(this,kernelObj);kernelObjs[kernelName]=kernelObj}debug("  Compiled kernels in %d ms.",(new Date).getTime()-t0);return kernelObjs}}catch(e){console.error("Kernel compilation error:",e.stack);throw e}});var acquire=function(buffers){return Q.all((buffers||[]).map(function(buffer){return buffer.acquire()}))};var release=function(buffers){return Q.all((buffers||[]).map(function(buffer){return buffer.release()}))};var call=Q.promised(function(kernel,threads,buffers){return acquire(buffers).then(function(){var workgroupSize=new Int32Array([threads]);kernel.cl.queue.enqueueNDRangeKernel(kernel.kernel,workgroupSize.length,[],workgroupSize,[])}).then(release.bind("",buffers)).then(function(){kernel.cl.queue.finish()}).then(_.constant(kernel))});var setArgs=function(kernel,args,argTypes){var t0=(new Date).getTime();for(var i=0;i<args.length;i++){if(args[i]!==null){kernel.kernel.setArg(i,args[i])}}debug("Set kernel args (%d ms)",(new Date).getTime()-t0);return kernel};var createBuffer=Q.promised(function createBuffer(cl,size,name){debug("Creating buffer %s",name);var buffer=cl.context.createBuffer(cl.cl.MEM_READ_WRITE,size);if(buffer===null){throw new Error("Could not create the WebCL buffer")}else{var bufObj={name:name,buffer:buffer,cl:cl,size:size,acquire:function(){return Q()},release:function(){return Q()}};bufObj.delete=Q.promised(function(){buffer.release();bufObj.size=0;return null});bufObj.write=write.bind(this,bufObj);bufObj.read=read.bind(this,bufObj);bufObj.copyInto=copyBuffer.bind(this,cl,bufObj);return bufObj}});var createBufferGL=Q.promised(function(cl,vbo,name){var t0=(new Date).getTime();debug("Creating buffer %s from GL buffer",name);var buffer=cl.context.createFromGLBuffer(cl.cl.MEM_READ_WRITE,vbo.buffer);if(buffer===null){throw new Error("Could not create WebCL buffer from WebGL buffer")}else{if(!buffer.getInfo){debug("WARNING: no getInfo() available on buffer %s",name)}var bufObj={name:name,buffer:buffer,cl:cl,size:buffer.getInfo?buffer.getInfo(cl.cl.MEM_SIZE):vbo.len,acquire:Q.promised(function(){cl.gl.finish();cl.queue.enqueueAcquireGLObjects([buffer])}),release:Q.promised(function(){cl.queue.enqueueReleaseGLObjects([buffer]);cl.queue.finish();cl.gl.finish()})};bufObj.delete=Q.promised(function(){return bufObj.release().then(function(){bufObj.release();bufObj.size=0;return null})});bufObj.write=write.bind(this,bufObj);bufObj.read=read.bind(this,bufObj);bufObj.copyInto=copyBuffer.bind(this,cl,bufObj);debug("  Created buffer in %d ms",(new Date).getTime()-t0);return bufObj}});var copyBuffer=Q.promised(function(cl,source,destination){debug("Copying buffer. Source: %s (%d bytes), destination %s (%d bytes)",source.name,source.size,destination.name,destination.size);return acquire([source,destination]).then(function(){cl.queue.enqueueCopyBuffer(source.buffer,destination.buffer,0,0,Math.min(source.size,destination.size))}).then(function(){cl.queue.finish()}).then(release.bind(null,[source,destination]))});var write=Q.promised(function write(buffer,data){debug("Writing to buffer %s",buffer.name);var t0=(new Date).getTime();return buffer.acquire().then(function(){buffer.cl.queue.enqueueWriteBuffer(buffer.buffer,true,0,data.byteLength,data);return buffer.release()}).then(function(){buffer.cl.queue.finish();debug("  Finished buffer %s write in %d ms",buffer.name,(new Date).getTime()-t0);return buffer})});var read=Q.promised(function(buffer,target){return buffer.acquire().then(function(){var copySize=Math.min(buffer.size,target.length*target.BYTES_PER_ELEMENT);buffer.cl.queue.enqueueReadBuffer(buffer.buffer,true,0,copySize,target);return buffer.release()}).then(function(){return buffer},function(err){console.error("Read error for buffer "+buffer.name+":",err)})});function polyfill(){if(typeof window!="undefined"&&typeof webcl.enableExtension=="function"){return false}debug("Detected old WebCL platform. Modifying functions to support it.");_createContext=function(cl,gl,platform,devices){if(webcl.type){return webcl.createContext({devices:devices,shareGroup:gl,platform:platform})}else{var extension=cl.getExtension("KHR_GL_SHARING");if(extension===null){throw new Error("Could not create a shared CL/GL context using the WebCL extension system")}return extension.createContext({platform:platform,devices:devices,deviceType:DEVICE_TYPE,sharedContext:null})}};call=Q.promised(function(kernel,threads,buffers){return acquire(buffers).then(function(){var workgroupSize=typeof window=="undefined"?[threads]:new Int32Array([threads]);if(webcl.type){kernel.cl.queue.enqueueNDRangeKernel(kernel.kernel,null,[threads],null)}else{kernel.cl.queue.enqueueNDRangeKernel(kernel.kernel,null,workgroupSize,null)}return release(buffers)}).then(function(){kernel.cl.queue.finish();return kernel})});setArgs=Q.promised(function(kernel,args,argTypes){var t0=(new Date).getTime();try{for(var i=0;i<args.length;i++){if(args[i]){kernel.kernel.setArg(i,args[i].length?args[i][0]:args[i],argTypes[i]||undefined)}}}catch(e){console.error("Error setting kernel args (in polyfilled setArgs()):",e,e.stack);throw new Error(e)}return kernel});if(typeof WebCLKernelArgumentTypes=="undefined"){var WebCLKernelArgumentTypes=webcl.type}types={char_t:WebCLKernelArgumentTypes.CHAR,double_t:WebCLKernelArgumentTypes.DOUBLE,float_t:WebCLKernelArgumentTypes.FLOAT,half_t:WebCLKernelArgumentTypes.HALF,int_t:WebCLKernelArgumentTypes.INT,local_t:WebCLKernelArgumentTypes.LOCAL_MEMORY_SIZE,long_t:WebCLKernelArgumentTypes.LONG,short_t:WebCLKernelArgumentTypes.SHORT,uchar_t:WebCLKernelArgumentTypes.UCHAR,uint_t:WebCLKernelArgumentTypes.UINT,ulong_t:WebCLKernelArgumentTypes.ULONG,ushort_t:WebCLKernelArgumentTypes.USHORT,float2_t:WebCLKernelArgumentTypes.VEC2,float3_t:WebCLKernelArgumentTypes.VEC3,float4_t:WebCLKernelArgumentTypes.VEC4,float8_t:WebCLKernelArgumentTypes.VEC8,float16_t:WebCLKernelArgumentTypes.VEC16};return true}var types={};var CURRENT_CL=!polyfill();module.exports={acquire:acquire,call:call,compile:compile,create:create,createBuffer:createBuffer,createBufferGL:createBufferGL,release:release,setArgs:setArgs,types:types,write:write,CURRENT_CL:CURRENT_CL}},{"./SimpleEvents.js":4,debug:14,"node-webcl":"fWqvvE",q:18,underscore:19}],6:[function(_dereq_,module,exports){"use strict";var MatrixLoader=_dereq_("./libs/load.js");var kmeans=_dereq_("./libs/kmeans.js");var _=_dereq_("underscore");var debug=_dereq_("debug")("StreamGL:data");function createPoints(amount,dim){var points=[];for(var i=0;i<amount;i++){points.push([Math.random()*dim[0],Math.random()*dim[1]])}return points}function createEdges(amount,numNodes){var edges=[];for(var i=0;i<amount;i++){var source=i%numNodes,target=(i+1)%numNodes;edges.push([source,target])}return edges}function loadGeo(graph,graphFileURI){debug("Loading Geo");return MatrixLoader.loadGeo(graphFileURI).then(function(geoData){var processedData=MatrixLoader.processGeo(geoData,.3);debug("Processed %d/%d nodes/edges",processedData.points.length,processedData.edges.length);return graph.setPoints(processedData.points).then(_.constant(processedData))}).then(function(processedData){var position=function(points,edges){return edges.map(function(pair){var start=points[pair[0]];var end=points[pair[1]];return[start[0],start[1],end[0],end[1]]})};var k=6;var steps=50;var positions=position(processedData.points,processedData.edges);var clusters=kmeans(positions,k,steps);return graph.setColorMap("test-colormap2.png",{clusters:clusters,points:processedData.points,edges:processedData.edges}).then(function(){debug("Setting edges");return graph.setEdges(processedData.edges)})}).then(function(){debug("Done setting geo points, edges");return graph})}function loadDataList(clGraph){function getDataList(listURI){return MatrixLoader.ls(listURI).then(function(files){var listing=[];files.forEach(function(file,i){listing.push({f:file.f,base:file.f.split(/\/|\./)[file.f.split(/\/|\./).length-3],KB:file.KB,size:file.KB>1e3?Math.round(file.KB/1e3)+" MB":file.KB+" KB"})});return listing})}var dataList=[];return getDataList("data/geo.json").then(function(geoList){debug("  geolist");geoList=geoList.map(function(fileInfo){fileInfo["base"]=fileInfo.base+".geo";fileInfo["loader"]=loadGeo;return fileInfo});dataList=dataList.concat(geoList);return getDataList("data/matrices.binary.json")}).then(function(matrixList){debug("  matrixlist");matrixList=matrixList.map(function(fileInfo){fileInfo["base"]=fileInfo.base+".mtx";fileInfo["loader"]=loadMatrix;return fileInfo});dataList=dataList.concat(matrixList);return dataList})}function loadMatrix(graph,graphFileURI){var graphFile;debug("Loading file %s",graphFileURI);return MatrixLoader.loadBinary(graphFileURI).then(function(v){graphFile=v;if(typeof $!="undefined"){$("#filenodes").text("Nodes: "+v.numNodes);$("#fileedges").text("Edges: "+v.numEdges)}var points=createPoints(graphFile.numNodes,graph.dimensions);return graph.setPoints(points)}).then(function(){return graph.setEdges(graphFile.edges)}).then(function(){return graph})}module.exports={createPoints:createPoints,createEdges:createEdges,loadGeo:loadGeo,loadDataList:loadDataList}},{"./libs/kmeans.js":8,"./libs/load.js":9,debug:14,underscore:19}],7:[function(_dereq_,module,exports){(function(global){var Long=function(low,high,unsigned){this.low=low|0;this.high=high|0;this.unsigned=!!unsigned};var INT_CACHE={};var UINT_CACHE={};Long.fromInt=function(value,unsigned){var obj,cachedObj;if(!unsigned){value=value|0;if(-128<=value&&value<128){cachedObj=INT_CACHE[value];if(cachedObj)return cachedObj}obj=new Long(value,value<0?-1:0,false);if(-128<=value&&value<128){INT_CACHE[value]=obj}return obj}else{value=value>>>0;if(0<=value&&value<256){cachedObj=UINT_CACHE[value];if(cachedObj)return cachedObj}obj=new Long(value,(value|0)<0?-1:0,true);if(0<=value&&value<256){UINT_CACHE[value]=obj}return obj}};Long.fromNumber=function(value,unsigned){unsigned=!!unsigned;if(isNaN(value)||!isFinite(value)){return Long.ZERO}else if(!unsigned&&value<=-TWO_PWR_63_DBL){return Long.MIN_SIGNED_VALUE}else if(unsigned&&value<=0){return Long.MIN_UNSIGNED_VALUE}else if(!unsigned&&value+1>=TWO_PWR_63_DBL){return Long.MAX_SIGNED_VALUE}else if(unsigned&&value>=TWO_PWR_64_DBL){return Long.MAX_UNSIGNED_VALUE}else if(value<0){return Long.fromNumber(-value,false).negate()}else{return new Long(value%TWO_PWR_32_DBL|0,value/TWO_PWR_32_DBL|0,unsigned)}};Long.fromBits=function(lowBits,highBits,unsigned){return new Long(lowBits,highBits,unsigned)};Long.from28Bits=function(part0,part1,part2,unsigned){return Long.fromBits(part0|part1<<28,part1>>>4|part2<<24,unsigned)};Long.fromString=function(str,unsigned,radix){if(str.length==0){throw new Error("number format error: empty string")}if(str==="NaN"||str==="Infinity"||str==="+Infinity"||str==="-Infinity"){return Long.ZERO}if(typeof unsigned==="number"){radix=unsigned;unsigned=false}radix=radix||10;if(radix<2||36<radix){throw new Error("radix out of range: "+radix)}if(str.charAt(0)=="-"){return Long.fromString(str.substring(1),unsigned,radix).negate()}else if(str.indexOf("-")>=0){throw new Error('number format error: interior "-" character: '+str)}var radixToPower=Long.fromNumber(Math.pow(radix,8));var result=Long.ZERO;for(var i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i);var value=parseInt(str.substring(i,i+size),radix);if(size<8){var power=Long.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Long.fromNumber(value))}else{result=result.multiply(radixToPower);result=result.add(Long.fromNumber(value))}}return result};var TWO_PWR_16_DBL=1<<16;var TWO_PWR_24_DBL=1<<24;var TWO_PWR_32_DBL=TWO_PWR_16_DBL*TWO_PWR_16_DBL;var TWO_PWR_31_DBL=TWO_PWR_32_DBL/2;var TWO_PWR_48_DBL=TWO_PWR_32_DBL*TWO_PWR_16_DBL;var TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL;var TWO_PWR_63_DBL=TWO_PWR_64_DBL/2;var TWO_PWR_24=Long.fromInt(1<<24);Long.ZERO=Long.fromInt(0);Long.ONE=Long.fromInt(1);Long.NEG_ONE=Long.fromInt(-1);Long.MAX_SIGNED_VALUE=Long.fromBits(4294967295|0,2147483647|0,false);Long.MAX_UNSIGNED_VALUE=Long.fromBits(4294967295|0,4294967295|0,true);Long.MAX_VALUE=Long.MAX_SIGNED_VALUE;Long.MIN_SIGNED_VALUE=Long.fromBits(0,2147483648|0,false);Long.MIN_UNSIGNED_VALUE=Long.fromBits(0,0,true);Long.MIN_VALUE=Long.MIN_SIGNED_VALUE;Long.prototype.toInt=function(){return this.unsigned?this.low>>>0:this.low};Long.prototype.toNumber=function(){if(this.unsigned){return(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0)}return this.high*TWO_PWR_32_DBL+(this.low>>>0)};Long.prototype.toString=function(radix){radix=radix||10;if(radix<2||36<radix){throw new Error("radix out of range: "+radix)}if(this.isZero()){return"0"}var rem;if(this.isNegative()){if(this.equals(Long.MIN_SIGNED_VALUE)){var radixLong=Long.fromNumber(radix);var div=this.div(radixLong);rem=div.multiply(radixLong).subtract(this);return div.toString(radix)+rem.toInt().toString(radix)}else{return"-"+this.negate().toString(radix)}}var radixToPower=Long.fromNumber(Math.pow(radix,6));rem=this;var result="";while(true){var remDiv=rem.div(radixToPower);var intval=rem.subtract(remDiv.multiply(radixToPower)).toInt();var digits=intval.toString(radix);rem=remDiv;if(rem.isZero()){return digits+result}else{while(digits.length<6){digits="0"+digits}result=""+digits+result}}};Long.prototype.getHighBits=function(){return this.high};Long.prototype.getHighBitsUnsigned=function(){return this.high>>>0};Long.prototype.getLowBits=function(){return this.low};Long.prototype.getLowBitsUnsigned=function(){return this.low>>>0};Long.prototype.getNumBitsAbs=function(){if(this.isNegative()){if(this.equals(Long.MIN_SIGNED_VALUE)){return 64}else{return this.negate().getNumBitsAbs()}}else{var val=this.high!=0?this.high:this.low;for(var bit=31;bit>0;bit--){if((val&1<<bit)!=0){break}}return this.high!=0?bit+33:bit+1}};Long.prototype.isZero=function(){return this.high==0&&this.low==0};Long.prototype.isNegative=function(){return!this.unsigned&&this.high<0};Long.prototype.isOdd=function(){return(this.low&1)==1};Long.prototype.isEven=function(){return(this.low&1)==0};Long.prototype.equals=function(other){if(this.unsigned!=other.unsigned&&this.high>>>31!=other.high>>>31)return false;return this.high==other.high&&this.low==other.low};Long.prototype.notEquals=function(other){return!this.equals(other)};Long.prototype.lessThan=function(other){return this.compare(other)<0};Long.prototype.lessThanOrEqual=function(other){return this.compare(other)<=0};Long.prototype.greaterThan=function(other){return this.compare(other)>0};Long.prototype.greaterThanOrEqual=function(other){return this.compare(other)>=0};Long.prototype.compare=function(other){if(this.equals(other)){return 0}var thisNeg=this.isNegative();var otherNeg=other.isNegative();if(thisNeg&&!otherNeg)return-1;if(!thisNeg&&otherNeg)return 1;if(!this.unsigned){return this.subtract(other).isNegative()?-1:1}else{return other.high>>>0>this.high>>>0||other.high==this.high&&other.low>>>0>this.low>>>0?-1:1}};Long.prototype.negate=function(){if(!this.unsigned&&this.equals(Long.MIN_SIGNED_VALUE)){return Long.MIN_SIGNED_VALUE}return this.not().add(Long.ONE)};Long.prototype.add=function(other){var a48=this.high>>>16;var a32=this.high&65535;var a16=this.low>>>16;var a00=this.low&65535;var b48=other.high>>>16;var b32=other.high&65535;var b16=other.low>>>16;var b00=other.low&65535;var c48=0,c32=0,c16=0,c00=0;c00+=a00+b00;c16+=c00>>>16;c00&=65535;c16+=a16+b16;c32+=c16>>>16;c16&=65535;c32+=a32+b32;c48+=c32>>>16;c32&=65535;c48+=a48+b48;c48&=65535;return Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)};Long.prototype.subtract=function(other){return this.add(other.negate())};Long.prototype.multiply=function(other){if(this.isZero()){return Long.ZERO}else if(other.isZero()){return Long.ZERO}if(this.equals(Long.MIN_VALUE)){return other.isOdd()?Long.MIN_VALUE:Long.ZERO}else if(other.equals(Long.MIN_VALUE)){return this.isOdd()?Long.MIN_VALUE:Long.ZERO}if(this.isNegative()){if(other.isNegative()){return this.negate().multiply(other.negate())}else{return this.negate().multiply(other).negate()}}else if(other.isNegative()){return this.multiply(other.negate()).negate()}if(this.lessThan(TWO_PWR_24)&&other.lessThan(TWO_PWR_24)){return Long.fromNumber(this.toNumber()*other.toNumber(),this.unsigned)}var a48=this.high>>>16;var a32=this.high&65535;var a16=this.low>>>16;var a00=this.low&65535;var b48=other.high>>>16;var b32=other.high&65535;var b16=other.low>>>16;var b00=other.low&65535;var c48=0,c32=0,c16=0,c00=0;c00+=a00*b00;c16+=c00>>>16;c00&=65535;c16+=a16*b00;c32+=c16>>>16;c16&=65535;c16+=a00*b16;c32+=c16>>>16;c16&=65535;c32+=a32*b00;c48+=c32>>>16;c32&=65535;c32+=a16*b16;c48+=c32>>>16;c32&=65535;c32+=a00*b32;c48+=c32>>>16;c32&=65535;c48+=a48*b00+a32*b16+a16*b32+a00*b48;c48&=65535;return Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)};Long.prototype.div=function(other){if(other.isZero()){throw new Error("division by zero")}else if(this.isZero()){return Long.ZERO}if(this.equals(Long.MIN_SIGNED_VALUE)){if(other.equals(Long.ONE)||other.equals(Long.NEG_ONE)){return min}else if(other.equals(Long.MIN_VALUE)){return Long.ONE}else{var halfThis=this.shiftRight(1);var approx=halfThis.div(other).shiftLeft(1);if(approx.equals(Long.ZERO)){return other.isNegative()?Long.ONE:Long.NEG_ONE}else{var rem=this.subtract(other.multiply(approx));var result=approx.add(rem.div(other));return result}}}else if(other.equals(Long.MIN_VALUE)){return Long.ZERO}if(this.isNegative()){if(other.isNegative()){return this.negate().div(other.negate())}else{return this.negate().div(other).negate()}}else if(other.isNegative()){return this.div(other.negate()).negate()}var res=Long.ZERO;var rem=this;while(rem.greaterThanOrEqual(other)){var approx=Math.max(1,Math.floor(rem.toNumber()/other.toNumber()));var log2=Math.ceil(Math.log(approx)/Math.LN2);var delta=log2<=48?1:Math.pow(2,log2-48);var approxRes=Long.fromNumber(approx,this.unsigned);var approxRem=approxRes.multiply(other);while(approxRem.isNegative()||approxRem.greaterThan(rem)){approx-=delta;approxRes=Long.fromNumber(approx,this.unsigned);approxRem=approxRes.multiply(other)}if(approxRes.isZero()){approxRes=Long.ONE}res=res.add(approxRes);rem=rem.subtract(approxRem)}return res};Long.prototype.modulo=function(other){return this.subtract(this.div(other).multiply(other))};Long.prototype.not=function(){return Long.fromBits(~this.low,~this.high,this.unsigned)};Long.prototype.and=function(other){return Long.fromBits(this.low&other.low,this.high&other.high,this.unsigned)};Long.prototype.or=function(other){return Long.fromBits(this.low|other.low,this.high|other.high,this.unsigned)};Long.prototype.xor=function(other){return Long.fromBits(this.low^other.low,this.high^other.high,this.unsigned)};Long.prototype.shiftLeft=function(numBits){numBits&=63;if(numBits==0){return this}else{var low=this.low;if(numBits<32){var high=this.high;return Long.fromBits(low<<numBits,high<<numBits|low>>>32-numBits,this.unsigned)}else{return Long.fromBits(0,low<<numBits-32,this.unsigned)}}};Long.prototype.shiftRight=function(numBits){numBits&=63;if(numBits==0){return this}else{var high=this.high;if(numBits<32){var low=this.low;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>numBits,this.unsigned)}else{return Long.fromBits(high>>numBits-32,high>=0?0:-1,this.unsigned)}}};Long.prototype.shiftRightUnsigned=function(numBits){numBits&=63;if(numBits==0){return this}else{var high=this.high;if(numBits<32){var low=this.low;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits,this.unsigned)}else if(numBits==32){return Long.fromBits(high,0,this.unsigned)}else{return Long.fromBits(high>>>numBits-32,0,this.unsigned)}}};Long.prototype.toSigned=function(){var l=this.clone();l.unsigned=false;return l};Long.prototype.toUnsigned=function(){var l=this.clone();l.unsigned=true;return l};Long.prototype.clone=function(){return new Long(this.low,this.high,this.unsigned)};if(typeof module!="undefined"&&module["exports"]){module["exports"]=Long}else if(typeof define!="undefined"&&define["amd"]){define("Math/Long",[],function(){return Long})}else{if(!global["dcodeIO"]){global["dcodeIO"]={}}global["dcodeIO"]["Long"]=Long}})(this)},{}],8:[function(_dereq_,module,exports){function kmeans(data,k,maxSteps){if(k>data.length)throw"k must be less than rank";function init(data,k){var opts=[];for(var i=0;i<data.length;i++)opts.push(i);var rows=[];for(var i=0;i<k;i++)rows.push(opts.splice(Math.round(Math.random()*opts.length),1));return rows.map(function(idx){return data[idx]})}function dist(row,center){var sum=0;for(var i=0;i<row.length;i++)sum+=Math.pow(row[i]-center[i],2);return Math.sqrt(sum)}function assign(row,centers){var center=0;var score=dist(row,centers[0]);for(var i=1;i<centers.length;i++){var attempt=dist(row,centers[i]);if(attempt<score){center=i;score=attempt}}return{cluster:center,score:score}}function assignAll(labeling,rows,centers){var anyChanged=false;var assignments=[];for(var i=0;i<centers.length;i++)assignments.push([]);for(var p=0;p<rows.length;p++){var before=labeling[p];var assignment=assign(rows[p],centers);if(assignment.cluster!=before){anyChanged=true;labeling[p]=assignment.cluster}assignments[assignment.cluster].push({row:p,dist:assignment.score})}return{anyChanged:anyChanged,clustering:assignments}}function recenterCluster(labeling,centers,data,k){var anyChanged=false;var numHits=0;for(var i=0;i<labeling.length;i++){if(labeling[i]==k)numHits++}if(!numHits){for(var f=0;f<centers[0].length;f++){var before=centers[k][f];centers[k][f]=0;anyChanged|=before!=0}return anyChanged}else{for(var f=0;f<centers[0].length;f++){var before=centers[k][f];var sum=0;for(var p=0;p<labeling.length;p++)if(labeling[p]==k)sum+=data[p][f];var newCenter=sum/numHits;centers[k][f]=newCenter;anyChanged|=before==newCenter}return anyChanged}}function recenterClusters(labeling,centers,data){var anyChanged=false;for(var k=0;k<centers.length;k++)anyChanged|=recenterCluster(labeling,centers,data,k);return anyChanged}var centers=init(data,k);var labeling=new Array(data.length);for(var i=0;i<data.length;i++)labeling[i]=0;for(var i=0;i<maxSteps;i++){var assignments=assignAll(labeling,data,centers);var assignChange=assignments.anyChanged;var clusterChange=recenterClusters(labeling,centers,data);var anyChanged=assignChange||clusterChange;if(!anyChanged){break}}var assignments=assignAll(labeling,data,centers);return{labeling:labeling,centers:centers,assignments:assignments.clustering}}module.exports=kmeans},{}],9:[function(_dereq_,module,exports){"use strict";var $=_dereq_("jQuery");var Q=_dereq_("Q");var Long=_dereq_("./Long.js");var debug=_dereq_("debug")("N-body:load");var exports={ls:function(matrixJson){var parts=matrixJson.split("/");parts.pop();var base=parts.join("/")+"/";var file=typeof window=="undefined"?Q.denodeify(_dereq_("fs").readFile)(matrixJson,{encoding:"utf8"}):Q($.ajax(matrixJson,{dataType:"text"}));return file.then(eval).then(function(lst){return lst.map(function(f){return{KB:f.KB,f:base+f.f}})})},loadBinary:function(file){debug("Loading binary file %s",file);var t0=(new Date).getTime();function Binary(buf){return{edges:buf.subarray(4),min:buf[0],max:buf[1],numNodes:buf[2],numEdges:buf[3]}}if(typeof window=="undefined"){var file=Q.denodeify(_dereq_("fs").readFile)(file);return file.then(function(nodeBuffer){return Binary(new Uint32Array(new Uint8Array(nodeBuffer).buffer))})}else{var res=Q.defer();var xhr=new XMLHttpRequest;xhr.open("GET",file,true);xhr.responseType="arraybuffer";xhr.onload=function(e){res.resolve(Binary(new Uint32Array(this.response)))};xhr.send();return res.promise}},load:function(file){var t0=(new Date).getTime();return typeof window=="undefined"?Q.denodeify(_dereq_("fs").readFile)(file,{encoding:"utf8"}):Q($.ajax(file,{dataType:"text"})).then(function(str){var nodes=[];var links=str.split(/\n/g).filter(function(d){return d.charAt(0)!="%"}).slice(1,-1).map(function(d){d=d.split(/\s+/g);var source=d[0]-1,target=d[1]-1;return{source:nodes[source]||(nodes[source]={index:source}),target:nodes[target]||(nodes[target]={index:target})}});debug("Did naive parse & transform in %d ms",(new Date).getTime()-t0);return{nodes:nodes,links:links}})},loadGeo:function(file){var t0=(new Date).getTime();debug("Loading Geo file %s",file);function Binary(buf){var f32=new Float32Array(buf.buffer);var i32=new Int32Array(buf.buffer);var ui32=buf;var struct32Length=1+2*(2+1+1);var struct8Length=4*(1+2*(2+1+1));function toUTC(low,high){return new Date(Long.fromBits(low,high,true).toNumber())}return{numEdges:buf.byteLength/struct8Length,id:function(i){return ui32[i*struct32Length]},startTime:function(i){var idx=i*struct32Length+1;return toUTC(i32[idx],i32[idx+1])},startLat:function(i){return f32[i*struct32Length+3]},startLng:function(i){return f32[i*struct32Length+4]},endTime:function(i){var idx=i*struct32Length+5;return toUTC(i32[idx],i32[idx+1])},endLat:function(i){return f32[i*struct32Length+7]},endLng:function(i){return f32[i*struct32Length+8]}}}var res=Q.defer();if(typeof window=="undefined"){debug("Loading geo data with node.js fs module");return Q.denodeify(_dereq_("fs").readFile)(file).then(function(nodeBuffer){return Binary(new Uint32Array(new Uint8Array(nodeBuffer).buffer))},function(err){console.error("Error loading geo data with fs module:",err)})}else{debug("Loading geo data with XHR");var xhr=new XMLHttpRequest;xhr.open("GET",file,true);xhr.responseType="arraybuffer";xhr.onload=function(e){res.resolve(Binary(new Uint32Array(this.response)))};xhr.send()}return res.promise},getGeoBounds:function(binary){var minLat=Number.POSITIVE_INFINITY;var maxLat=Number.NEGATIVE_INFINITY;var minLng=Number.POSITIVE_INFINITY;var maxLng=Number.NEGATIVE_INFINITY;var avgLat=0;var avgLng=0;var sLat=0;var sLng=0;for(var i=0;i<binary.numEdges;i++){minLat=Math.min(Math.min(minLat,binary.startLat(i)),binary.endLat(i));maxLat=Math.max(Math.max(maxLat,binary.startLat(i)),binary.endLat(i));minLng=Math.min(Math.min(minLng,binary.startLng(i)),binary.endLng(i));maxLng=Math.max(Math.max(maxLng,binary.startLng(i)),binary.endLng(i));var newAvgLat=avgLat+(binary.startLat(i)+binary.endLat(i)-2*avgLat)/(i+2);sLat=sLat+(binary.startLat(i)-newAvgLat)*(binary.startLat(i)-avgLat)+(binary.endLat(i)-newAvgLat)*(binary.endLat(i)-avgLat);avgLat=newAvgLat;var newAvgLng=avgLng+(binary.startLng(i)+binary.endLng(i)-2*avgLng)/(i+2);sLng=sLng+(binary.startLng(i)-newAvgLng)*(binary.startLng(i)-avgLng)+(binary.endLng(i)-newAvgLng)*(binary.endLng(i)-avgLng);avgLng=newAvgLng}var stdLat=Math.sqrt(sLat/(binary.numEdges-1));var stdLng=Math.sqrt(sLng/(binary.numEdges-1));return{lat:{min:minLat,max:maxLat,stats:{avg:avgLat,std:stdLat},scale:{c:-(avgLat-1.5*stdLat),x:3*stdLat}},lng:{min:minLng,max:maxLng,stats:{avg:avgLng,std:stdLng},scale:{c:-(avgLng-1.5*stdLng),x:3*stdLng}}}},processGeo:function(geoData,keepPercent){keepPercent=keepPercent||.3;var points=[],edges=[],bounds=exports.getGeoBounds(geoData);for(var i=0;i<geoData.numEdges;i++){if(Math.random()>keepPercent){continue}points.push([(geoData.startLng(i)+bounds.lng.scale.c)/bounds.lng.scale.x,(geoData.startLat(i)+bounds.lat.scale.c)/bounds.lat.scale.x]);points.push([(geoData.endLng(i)+bounds.lng.scale.c)/bounds.lng.scale.x,(geoData.endLat(i)+bounds.lat.scale.c)/bounds.lat.scale.x]);edges.push([points.length-2,points.length-1])}return{points:points,edges:edges}}};module.exports=exports},{"./Long.js":7,Q:13,debug:14,fs:20,jQuery:"nHrylo"}],10:[function(_dereq_,module,exports){var Stats=function(){var startTime=Date.now(),prevTime=startTime;
var ms=0,msMin=Infinity,msMax=0;var fps=0,fpsMin=Infinity,fpsMax=0;var frames=0,mode=0;var container=document.createElement("div");container.id="stats";container.addEventListener("mousedown",function(event){event.preventDefault();setMode(++mode%2)},false);container.style.cssText="width:80px;opacity:0.9;cursor:pointer";var fpsDiv=document.createElement("div");fpsDiv.id="fps";fpsDiv.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002";container.appendChild(fpsDiv);var fpsText=document.createElement("div");fpsText.id="fpsText";fpsText.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";fpsText.innerHTML="FPS";fpsDiv.appendChild(fpsText);var fpsGraph=document.createElement("div");fpsGraph.id="fpsGraph";fpsGraph.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";fpsDiv.appendChild(fpsGraph);while(fpsGraph.children.length<74){var bar=document.createElement("span");bar.style.cssText="width:1px;height:30px;float:left;background-color:#113";fpsGraph.appendChild(bar)}var msDiv=document.createElement("div");msDiv.id="ms";msDiv.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";container.appendChild(msDiv);var msText=document.createElement("div");msText.id="msText";msText.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";msText.innerHTML="MS";msDiv.appendChild(msText);var msGraph=document.createElement("div");msGraph.id="msGraph";msGraph.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";msDiv.appendChild(msGraph);while(msGraph.children.length<74){var bar=document.createElement("span");bar.style.cssText="width:1px;height:30px;float:left;background-color:#131";msGraph.appendChild(bar)}var setMode=function(value){mode=value;switch(mode){case 0:fpsDiv.style.display="block";msDiv.style.display="none";break;case 1:fpsDiv.style.display="none";msDiv.style.display="block";break}};var updateGraph=function(dom,value){var child=dom.appendChild(dom.firstChild);child.style.height=value+"px"};return{REVISION:11,domElement:container,setMode:setMode,begin:function(){startTime=Date.now()},end:function(){var time=Date.now();ms=time-startTime;msMin=Math.min(msMin,ms);msMax=Math.max(msMax,ms);msText.textContent=ms+" MS ("+msMin+"-"+msMax+")";updateGraph(msGraph,Math.min(30,30-ms/200*30));frames++;if(time>prevTime+1e3){fps=Math.round(frames*1e3/(time-prevTime));fpsMin=Math.min(fpsMin,fps);fpsMax=Math.max(fpsMax,fps);fpsText.textContent=fps+" FPS ("+fpsMin+"-"+fpsMax+")";updateGraph(fpsGraph,Math.min(30,30-fps/100*30));prevTime=time;frames=0}return time},update:function(){startTime=this.end()}}};module.exports=Stats},{}],11:[function(_dereq_,module,exports){"use strict";var $=_dereq_("jQuery"),NBody=_dereq_("./NBody.js"),RenderGL=_dereq_("./RenderGL.js"),SimCL=_dereq_("./SimCL.js"),MatrixLoader=_dereq_("./libs/load.js"),Q=_dereq_("q"),Stats=_dereq_("./libs/stats.js"),events=_dereq_("./SimpleEvents.js"),kmeans=_dereq_("./libs/kmeans.js"),loader=_dereq_("./data-loader.js");var graph=null,numPoints=1e3,num,numEdges=numPoints,dimensions=[1,1];function animator(document,doStepPromised){var animating=false;var next=function(f){var base=typeof window=="undefined"?document:window;base.requestAnimationFrame(f)};var step=0;var bound=Infinity;var res={stopAnimation:function(){animating=false;return res},startAnimation:function(maybeCb,maybeMaxSteps){if(typeof maybeMaxSteps==="number"){bound=maybeMaxSteps;var announceIncrement=Math.round(maybeMaxSteps/10);console.debug("Starting graph animation for",maybeMaxSteps,"steps")}else{var announceIncrement=1e3;console.debug("Starting graph animation and running forever")}animating=true;var run=function(){step++;bound--;if(step>0&&step%announceIncrement===0){console.debug("Animating step",step,"("+bound+" steps left)")}doStepPromised().then(function(){if(animating&&bound!=0){next(run)}else{if(maybeCb)maybeCb()}},function(){console.error("ERROR",err,err.stack)})};next(run);return res}};return res}function setup(){console.log("Running Naive N-body simulation");return NBody.create(SimCL,RenderGL,document,$("#simulation")[0],[0,0,0,0],dimensions,3).then(function(createdGraph){graph=createdGraph;console.log("N-body graph created.");var points=loader.createPoints(numPoints,dimensions);var edges=loader.createEdges(numEdges,numPoints);return Q.all([graph.setPoints(points),points,edges])}).spread(function(graph,points,edges){graph.setColorMap("test-colormap2.png");return graph.setEdges(edges)}).then(function(graph){var fpsTotal=new Stats;fpsTotal.setMode(0);$("#fpsTotal").append(fpsTotal.domElement);events.listen("tickBegin",function(){fpsTotal.begin()});events.listen("tickEnd",function(){fpsTotal.end()});var fpsSim=new Stats;fpsSim.setMode(1);$("#fpsSim").append(fpsSim.domElement);events.listen("simulateBegin",function(){fpsSim.begin()});events.listen("simulateEnd",function(){fpsSim.end()});var fpsRender=new Stats;fpsRender.setMode(1);$("#fpsRender").append(fpsRender.domElement);events.listen("renderBegin",function(){fpsRender.begin()});events.listen("renderEnd",function(){fpsRender.end()});var animButton=$("#anim-button");var stepButton=$("#step-button");var animation=animator(document,graph.tick);function startAnimation(){animButton.text("Stop");stepButton.prop("disabled",true);animButton.off().on("click",function(){animation.stopAnimation();stepButton.prop("disabled",false);animButton.text("Animate");animButton.off().on("click",startAnimation)});animation.startAnimation()}animButton.on("click",startAnimation);stepButton.on("click",function(){animation.stopAnimation();stepButton.prop("disabled",true);graph.tick().then(function(){stepButton.prop("disabled",false)})});animButton.prop("disabled",false);stepButton.prop("disabled",false);return graph})}function bindSliders(graph){console.debug("setting physics");$("#charge").on("change",function(e){var v=$(this).val();var res=.1;for(var i=0;i<100-v;i++)res/=1.3;var scaled=-1*res;graph.setPhysics({charge:scaled})});$("#gravity").on("change",function(e){var v=$(this).val();var res=100;for(var i=0;i<100-v;i++)res/=1.3;var scaled=1*res;graph.setPhysics({gravity:scaled})});$("#strength").on("change",function(e){var v=$(this).val();var res=100;for(var i=0;i<100-v;i++)res/=1.3;var scaled=1*res;graph.setPhysics({edgeStrength:scaled})});$("#length").on("change",function(e){var v=$(this).val();var res=100;for(var i=0;i<100-v;i++)res/=1.3;var scaled=1*res;graph.setPhysics({edgeDistance:scaled})});["points","edges","midpoints","midedges"].forEach(function(name){function bang(){var obj={};obj[name]=$(this).is(":checked");graph.setVisible(obj)}$("#"+name).on("change",bang);bang.call($("#"+name))});["lockPoints","lockEdges","lockMidpoints","lockMidedges"].forEach(function(name){function bang(){var obj={};obj[name]=$(this).is(":checked");graph.setLocked(obj)}$("#"+name).on("change",bang);bang.call($("#"+name))})}function renderDataList(dataList,graph){var dataEl=$("#datasets");dataList.forEach(function(dataSet,i){dataEl.append($("<option></option>").attr("value",i).text(i+". "+dataSet.base+" ("+dataSet.size+")"))});dataEl.prop("selectedIndex",-1);$("#datasets").on("change",function(){var dataSet=dataList[parseInt(this.value)];return dataSet.loader(graph,dataSet.f).then(function(){graph.tick()}).catch(function(err){console.error("Error loading matrix:",err);throw err})})}$(function(){setup().then(function(){console.debug("SETUP, LOADING DATA");return loader.loadDataList(graph)}).then(function(dataList){renderDataList(dataList,graph)}).then(function(){console.debug("LOADED DATA, BINDING");return bindSliders(graph)}).then(function(){graph.tick()}).then(function(){console.debug("DONE")},function(err){console.error("oops",err,err.stack)})})},{"./NBody.js":1,"./RenderGL.js":2,"./SimCL.js":3,"./SimpleEvents.js":4,"./data-loader.js":6,"./libs/kmeans.js":8,"./libs/load.js":9,"./libs/stats.js":10,jQuery:"nHrylo",q:18}],12:[function(_dereq_,module,exports){"use strict";var $=_dereq_("jQuery");var Q=_dereq_("Q");var debug=_dereq_("debug")("N-body:utils");if(typeof window=="undefined"){var webgl=_dereq_("node-webgl");var Image=webgl.Image}function getSource(id){if(typeof window=="undefined"){var fs=_dereq_("fs");return Q.denodeify(fs.readFile)("shaders/"+id,{encoding:"utf8"})}else{var url="shaders/"+id;return Q($.ajax(url,{dataType:"text"}))}}function getImage(url){var deferred=Q.defer();try{var img=new Image;img.onload=function(){debug("Done loading <img>");deferred.resolve(img)};debug("Loading <img> from src %s",url);img.src=url;debug("  <img> src set")}catch(e){deferred.reject(e)}return deferred.promise}function extend(target,object1,objectN){for(var arg=1;arg<arguments.length;arg++){for(var i in arguments[arg]){target[i]=arguments[arg][i]}}return target}module.exports={getSource:getSource,getImage:getImage,extend:extend}},{Q:13,debug:14,fs:20,jQuery:"nHrylo","node-webgl":"+YTs4a"}],13:[function(_dereq_,module,exports){(function(process){(function(definition){if(typeof bootstrap==="function"){bootstrap("promise",definition)}else if(typeof exports==="object"){module.exports=definition()}else if(typeof define==="function"&&define.amd){define(definition)}else if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=definition}}else{Q=definition()}})(function(){"use strict";var hasStacks=false;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine();var qFileName;var noop=function(){};var nextTick=function(){var head={task:void 0,next:null};var tail=head;var flushing=false;var requestTick=void 0;var isNodeJS=false;function flush(){while(head.next){head=head.next;var task=head.task;head.task=void 0;var domain=head.domain;if(domain){head.domain=void 0;domain.enter()}try{task()}catch(e){if(isNodeJS){if(domain){domain.exit()}setTimeout(flush,0);if(domain){domain.enter()}throw e}else{setTimeout(function(){throw e},0)}}if(domain){domain.exit()}}flushing=false}nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null};if(!flushing){flushing=true;requestTick()}};if(typeof process!=="undefined"&&process.nextTick){isNodeJS=true;requestTick=function(){process.nextTick(flush)}}else if(typeof setImmediate==="function"){if(typeof window!=="undefined"){requestTick=setImmediate.bind(window,flush)}else{requestTick=function(){setImmediate(flush)}}}else if(typeof MessageChannel!=="undefined"){var channel=new MessageChannel;channel.port1.onmessage=function(){requestTick=requestPortTick;channel.port1.onmessage=flush;flush()};var requestPortTick=function(){channel.port2.postMessage(0)};requestTick=function(){setTimeout(flush,0);requestPortTick()}}else{requestTick=function(){setTimeout(flush,0)}}return nextTick}();var call=Function.call;function uncurryThis(f){return function(){return call.apply(f,arguments)}}var array_slice=uncurryThis(Array.prototype.slice);var array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(arguments.length===1){do{if(index in this){basis=this[index++];break}if(++index>=length){throw new TypeError}}while(1)}for(;index<length;index++){if(index in this){basis=callback(basis,this[index],index)}}return basis});var array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++){if(this[i]===value){return i}}return-1});var array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this;var collect=[];array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0);return collect});var object_create=Object.create||function(prototype){function Type(){}Type.prototype=prototype;return new Type};var object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty);var object_keys=Object.keys||function(object){var keys=[];for(var key in object){if(object_hasOwnProperty(object,key)){keys.push(key)}}return keys};var object_toString=uncurryThis(Object.prototype.toString);function isObject(value){return value===Object(value)}function isStopIteration(exception){return object_toString(exception)==="[object StopIteration]"||exception instanceof QReturnValue}var QReturnValue;if(typeof ReturnValue!=="undefined"){QReturnValue=ReturnValue}else{QReturnValue=function(value){this.value=value}}var STACK_JUMP_SEPARATOR="From previous event:";function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&typeof error==="object"&&error!==null&&error.stack&&error.stack.indexOf(STACK_JUMP_SEPARATOR)===-1){var stacks=[];for(var p=promise;!!p;p=p.source){if(p.stack){stacks.unshift(p.stack)}}stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){var lines=stackString.split("\n");var desiredLines=[];for(var i=0;i<lines.length;++i){var line=lines[i];if(!isInternalFrame(line)&&!isNodeFrame(line)&&line){desiredLines.push(line)}}return desiredLines.join("\n")}function isNodeFrame(stackLine){return stackLine.indexOf("(module.js:")!==-1||stackLine.indexOf("(node.js:")!==-1}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1){return[attempt1[1],Number(attempt1[2])]}var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2){return[attempt2[1],Number(attempt2[2])]}var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);if(attempt3){return[attempt3[1],Number(attempt3[2])]}}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber){return false}var fileName=fileNameAndLineNumber[0];var lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&lineNumber<=qEndingLine}function captureLine(){if(!hasStacks){return}try{throw new Error}catch(e){var lines=e.stack.split("\n");var firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2];var fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber){return}qFileName=fileNameAndLineNumber[0];return fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack)}return callback.apply(callback,arguments)}}function Q(value){if(isPromise(value)){return value}if(isPromiseAlike(value)){return coerce(value)}else{return fulfill(value)}}Q.resolve=Q;Q.nextTick=nextTick;Q.longStackSupport=false;Q.defer=defer;function defer(){var messages=[],progressListeners=[],resolvedPromise;var deferred=object_create(defer.prototype);var promise=object_create(Promise.prototype);promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);if(messages){messages.push(args);if(op==="when"&&operands[1]){progressListeners.push(operands[1])}}else{nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})}};promise.valueOf=function(){if(messages){return promise}var nearerValue=nearer(resolvedPromise);if(isPromise(nearerValue)){resolvedPromise=nearerValue}return nearerValue};promise.inspect=function(){if(!resolvedPromise){return{state:"pending"}}return resolvedPromise.inspect()};if(Q.longStackSupport&&hasStacks){try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}}function become(newPromise){resolvedPromise=newPromise;promise.source=newPromise;array_reduce(messages,function(undefined,message){nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0);messages=void 0;progressListeners=void 0}deferred.promise=promise;deferred.resolve=function(value){if(resolvedPromise){return}become(Q(value))};deferred.fulfill=function(value){if(resolvedPromise){return}become(fulfill(value))};deferred.reject=function(reason){if(resolvedPromise){return}become(reject(reason))};deferred.notify=function(progress){if(resolvedPromise){return}array_reduce(progressListeners,function(undefined,progressListener){nextTick(function(){progressListener(progress)})},void 0)};return deferred}defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){if(error){self.reject(error)}else if(arguments.length>2){self.resolve(array_slice(arguments,1))}else{self.resolve(value)}}};Q.Promise=promise;Q.promise=promise;function promise(resolver){if(typeof resolver!=="function"){throw new TypeError("resolver must be a function.")}var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}promise.race=race;promise.all=all;promise.reject=reject;promise.resolve=Q;Q.passByCopy=function(object){return object};Promise.prototype.passByCopy=function(){return this};Q.join=function(x,y){return Q(x).join(y)};Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y){return x}else{throw new Error("Can't join: not the same: "+x+" "+y)}})};Q.race=race;function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;i<len;i++){Q(answerPs[i]).then(resolve,reject)}})}Promise.prototype.race=function(){return this.then(Q.race)};Q.makePromise=Promise;function Promise(descriptor,fallback,inspect){if(fallback===void 0){fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}}if(inspect===void 0){inspect=function(){return{state:"unknown"}}}var promise=object_create(Promise.prototype);promise.promiseDispatch=function(resolve,op,args){var result;try{if(descriptor[op]){result=descriptor[op].apply(promise,args)}else{result=fallback.call(promise,op,args)}}catch(exception){result=reject(exception)}if(resolve){resolve(result)}};promise.inspect=inspect;if(inspect){var inspected=inspect();if(inspected.state==="rejected"){promise.exception=inspected.reason}promise.valueOf=function(){var inspected=inspect();if(inspected.state==="pending"||inspected.state==="rejected"){return promise}return inspected.value}}return promise}Promise.prototype.toString=function(){return"[object Promise]"};Promise.prototype.then=function(fulfilled,rejected,progressed){var self=this;var deferred=defer();var done=false;function _fulfilled(value){try{return typeof fulfilled==="function"?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if(typeof rejected==="function"){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return typeof progressed==="function"?progressed(value):value}nextTick(function(){self.promiseDispatch(function(value){if(done){return}done=true;deferred.resolve(_fulfilled(value))},"when",[function(exception){if(done){return}done=true;deferred.resolve(_rejected(exception))}])});self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue;var threw=false;try{newValue=_progressed(value)}catch(e){threw=true;if(Q.onerror){Q.onerror(e)}else{throw e}}if(!threw){deferred.notify(newValue)}}]);return deferred.promise};Q.when=when;function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}Promise.prototype.thenResolve=function(value){return this.then(function(){return value})};Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)};Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})};Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)};Q.nearer=nearer;function nearer(value){if(isPromise(value)){var inspected=value.inspect();if(inspected.state==="fulfilled"){return inspected.value}}return value}Q.isPromise=isPromise;function isPromise(object){return isObject(object)&&typeof object.promiseDispatch==="function"&&typeof object.inspect==="function"}Q.isPromiseAlike=isPromiseAlike;function isPromiseAlike(object){return isObject(object)&&typeof object.then==="function"}Q.isPending=isPending;function isPending(object){return isPromise(object)&&object.inspect().state==="pending"}Promise.prototype.isPending=function(){return this.inspect().state==="pending"};Q.isFulfilled=isFulfilled;function isFulfilled(object){return!isPromise(object)||object.inspect().state==="fulfilled"}Promise.prototype.isFulfilled=function(){return this.inspect().state==="fulfilled"};Q.isRejected=isRejected;function isRejected(object){return isPromise(object)&&object.inspect().state==="rejected"}Promise.prototype.isRejected=function(){return this.inspect().state==="rejected"};var unhandledReasons=[];var unhandledRejections=[];var trackUnhandledRejections=true;function resetUnhandledRejections(){unhandledReasons.length=0;unhandledRejections.length=0;if(!trackUnhandledRejections){trackUnhandledRejections=true}}function trackRejection(promise,reason){if(!trackUnhandledRejections){return}unhandledRejections.push(promise);if(reason&&typeof reason.stack!=="undefined"){unhandledReasons.push(reason.stack)}else{unhandledReasons.push("(no stack) "+reason)}}function untrackRejection(promise){if(!trackUnhandledRejections){return}var at=array_indexOf(unhandledRejections,promise);if(at!==-1){unhandledRejections.splice(at,1);unhandledReasons.splice(at,1)}}Q.resetUnhandledRejections=resetUnhandledRejections;Q.getUnhandledReasons=function(){return unhandledReasons.slice()};Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections();trackUnhandledRejections=false};resetUnhandledRejections();Q.reject=reject;function reject(reason){var rejection=Promise({when:function(rejected){if(rejected){untrackRejection(this)}return rejected?rejected(reason):this}},function fallback(){return this},function inspect(){return{state:"rejected",reason:reason}});trackRejection(rejection,reason);return rejection}Q.fulfill=fulfill;function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){if(name===null||name===void 0){return value.apply(void 0,args)}else{return value[name].apply(value,args)}},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function inspect(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}});return deferred.promise}Q.master=master;function master(object){return Promise({isDef:function(){}},function fallback(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}Q.spread=spread;function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)};Q.async=async;function async(makeGenerator){return function(){function continuer(verb,arg){var result;if(typeof StopIteration==="undefined"){try{result=generator[verb](arg)}catch(exception){return reject(exception)}if(result.done){return result.value}else{return when(result.value,callback,errback)}}else{try{result=generator[verb](arg)}catch(exception){if(isStopIteration(exception)){return exception.value}else{return reject(exception)}}return when(result,callback,errback)}}var generator=makeGenerator.apply(this,arguments);var callback=continuer.bind(continuer,"next");var errback=continuer.bind(continuer,"throw");return callback()}}Q.spawn=spawn;function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}Q["return"]=_return;function _return(value){throw new QReturnValue(value)}Q.promised=promised;function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}Q.dispatch=dispatch;function dispatch(object,op,args){return Q(object).dispatch(op,args)}Promise.prototype.dispatch=function(op,args){var self=this;var deferred=defer();nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)});return deferred.promise};Q.get=function(object,key){return Q(object).dispatch("get",[key])};Promise.prototype.get=function(key){return this.dispatch("get",[key])};Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])};Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])};Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])};Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])};Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])};Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])};Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])};Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])};Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])};Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])};Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])};Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])};Q.fbind=function(object){var promise=Q(object);var args=array_slice(arguments,1);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}};Promise.prototype.fbind=function(){var promise=this;var args=array_slice(arguments);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}};Q.keys=function(object){return Q(object).dispatch("keys",[])};Promise.prototype.keys=function(){return this.dispatch("keys",[])};Q.all=all;function all(promises){return when(promises,function(promises){var countDown=0;var deferred=defer();array_reduce(promises,function(undefined,promise,index){var snapshot;if(isPromise(promise)&&(snapshot=promise.inspect()).state==="fulfilled"){promises[index]=snapshot.value}else{++countDown;when(promise,function(value){promises[index]=value;if(--countDown===0){deferred.resolve(promises)}},deferred.reject,function(progress){deferred.notify({index:index,value:progress})})}},void 0);if(countDown===0){deferred.resolve(promises)}return deferred.promise})}Promise.prototype.all=function(){return all(this)};Q.allResolved=deprecate(allResolved,"allResolved","allSettled");function allResolved(promises){return when(promises,function(promises){promises=array_map(promises,Q);return when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}Promise.prototype.allResolved=function(){return allResolved(this)};Q.allSettled=allSettled;function allSettled(promises){return Q(promises).allSettled()}Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){promise=Q(promise);function regardless(){return promise.inspect()}return promise.then(regardless,regardless)}))})};Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)};Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)};Q.progress=progress;function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)};Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)};Promise.prototype.fin=Promise.prototype["finally"]=function(callback){callback=Q(callback);return this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})};Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)};Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){nextTick(function(){makeStackTraceLong(error,promise);if(Q.onerror){Q.onerror(error)}else{throw error}})};var promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;if(typeof process==="object"&&process&&process.domain){onUnhandledError=process.domain.bind(onUnhandledError)}promise.then(void 0,onUnhandledError)};Q.timeout=function(object,ms,message){return Q(object).timeout(ms,message)};Promise.prototype.timeout=function(ms,message){var deferred=defer();var timeoutId=setTimeout(function(){deferred.reject(new Error(message||"Timed out after "+ms+" ms"))},ms);this.then(function(value){clearTimeout(timeoutId);deferred.resolve(value)},function(exception){clearTimeout(timeoutId);deferred.reject(exception)},deferred.notify);return deferred.promise};Q.delay=function(object,timeout){if(timeout===void 0){timeout=object;object=void 0}return Q(object).delay(timeout)};Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();setTimeout(function(){deferred.resolve(value)},timeout);return deferred.promise})};Q.nfapply=function(callback,args){return Q(callback).nfapply(args)};Promise.prototype.nfapply=function(args){var deferred=defer();var nodeArgs=array_slice(args);nodeArgs.push(deferred.makeNodeResolver());this.fapply(nodeArgs).fail(deferred.reject);return deferred.promise};Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)};Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.fapply(nodeArgs).fail(deferred.reject);return deferred.promise};Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments));var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());Q(callback).fapply(nodeArgs).fail(deferred.reject);return deferred.promise}};Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);args.unshift(this);return Q.denodeify.apply(void 0,args)};Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments));var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());function bound(){return callback.apply(thisp,arguments)}Q(bound).fapply(nodeArgs).fail(deferred.reject);return deferred.promise}};Promise.prototype.nbind=function(){var args=array_slice(arguments,0);args.unshift(this);return Q.nbind.apply(void 0,args)};Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)};Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Q.nodeify=nodeify;function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}Promise.prototype.nodeify=function(nodeback){if(nodeback){this.then(function(value){nextTick(function(){nodeback(null,value)})},function(error){nextTick(function(){nodeback(error)})})}else{return this}};var qEndingLine=captureLine();return Q})}).call(this,_dereq_("IMmnkj"))
},{IMmnkj:21}],14:[function(_dereq_,module,exports){exports=module.exports=_dereq_("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function useColors(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}exports.formatters.j=function(v){return JSON.stringify(v)};function formatArgs(){var args=arguments;var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return args;var c="color: "+this.color;args=[args[0],c,"color: inherit"].concat(Array.prototype.slice.call(args,1));var index=0;var lastC=0;args[0].replace(/%[a-z%]/g,function(match){if("%%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c);return args}function log(){return"object"==typeof console&&"function"==typeof console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){localStorage.removeItem("debug")}else{localStorage.debug=namespaces}}catch(e){}}function load(){var r;try{r=localStorage.debug}catch(e){}return r}exports.enable(load())},{"./debug":15}],15:[function(_dereq_,module,exports){exports=module.exports=debug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=_dereq_("ms");exports.names=[];exports.skips=[];exports.formatters={};var prevColor=0;var prevTime;function selectColor(){return exports.colors[prevColor++%exports.colors.length]}function debug(namespace){function disabled(){}disabled.enabled=false;function enabled(){var self=enabled;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;if(null==self.useColors)self.useColors=exports.useColors();if(null==self.color&&self.useColors)self.color=selectColor();var args=Array.prototype.slice.call(arguments);args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args=["%o"].concat(args)}var index=0;args[0]=args[0].replace(/%([a-z%])/g,function(match,format){if(match==="%%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});if("function"===typeof exports.formatArgs){args=exports.formatArgs.apply(self,args)}var logFn=enabled.log||exports.log||console.log.bind(console);logFn.apply(self,args)}enabled.enabled=true;var fn=exports.enabled(namespace)?enabled:disabled;fn.namespace=namespace;return fn}function enable(namespaces){exports.save(namespaces);var split=(namespaces||"").split(/[\s,]+/);var len=split.length;for(var i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:16}],16:[function(_dereq_,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};if("string"==typeof val)return parse(val);return options.long?long(val):short(val)};function parse(str){var match=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(str);if(!match)return;var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"h":return n*h;case"minutes":case"minute":case"m":return n*m;case"seconds":case"second":case"s":return n*s;case"ms":return n}}function short(ms){if(ms>=d)return Math.round(ms/d)+"d";if(ms>=h)return Math.round(ms/h)+"h";if(ms>=m)return Math.round(ms/m)+"m";if(ms>=s)return Math.round(ms/s)+"s";return ms+"ms"}function long(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n)return;if(ms<n*1.5)return Math.floor(ms/n)+" "+name;return Math.ceil(ms/n)+" "+name+"s"}},{}],17:[function(_dereq_,module,exports){(function(){"use strict";var shim={};if(typeof exports==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){shim.exports={};define(function(){return shim.exports})}else{shim.exports=window}}else{shim.exports=exports}(function(exports){if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}if(!GLMAT_ARRAY_TYPE){var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}var glMatrix={};glMatrix.setMatrixArrayType=function(type){GLMAT_ARRAY_TYPE=type};if(typeof exports!=="undefined"){exports.glMatrix=glMatrix}var vec2={};vec2.create=function(){var out=new GLMAT_ARRAY_TYPE(2);out[0]=0;out[1]=0;return out};vec2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new GLMAT_ARRAY_TYPE(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.sub=vec2.subtract;vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.mul=vec2.multiply;vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.div=vec2.divide;vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.dist=vec2.distance;vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.sqrDist=vec2.squaredDistance;vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.len=vec2.length;vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.sqrLen=vec2.squaredLength;vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out};vec2.transformMat2d=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out};vec2.transformMat3=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out};vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out};vec2.forEach=function(){var vec=vec2.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}var vec3={};vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out};vec3.normalize=function(out,a){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out};vec3.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined"){exports.vec3=vec3}var vec4={};vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.vec4=vec4}var mat2={};var mat2Identity=new Float32Array([1,0,0,1]);mat2.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.transpose=function(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out};mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out};mat2.adjoint=function(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out};mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a1*b2;out[1]=a0*b1+a1*b3;out[2]=a2*b0+a3*b2;out[3]=a2*b1+a3*b3;return out};mat2.mul=mat2.multiply;mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a1*s;out[1]=a0*-s+a1*c;out[2]=a2*c+a3*s;out[3]=a2*-s+a3*c;return out};mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v1;out[2]=a2*v0;out[3]=a3*v1;return out};mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.mat2=mat2}var mat2d={};var mat2dIdentity=new Float32Array([1,0,0,1,0,0]);mat2d.create=function(){var out=new GLMAT_ARRAY_TYPE(6);out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.clone=function(a){var out=new GLMAT_ARRAY_TYPE(6);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.invert=function(out,a){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5];var det=aa*ad-ab*ac;if(!det){return null}det=1/det;out[0]=ad*det;out[1]=-ab*det;out[2]=-ac*det;out[3]=aa*det;out[4]=(ac*aty-ad*atx)*det;out[5]=(ab*atx-aa*aty)*det;return out};mat2d.determinant=function(a){return a[0]*a[3]-a[1]*a[2]};mat2d.multiply=function(out,a,b){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],ba=b[0],bb=b[1],bc=b[2],bd=b[3],btx=b[4],bty=b[5];out[0]=aa*ba+ab*bc;out[1]=aa*bb+ab*bd;out[2]=ac*ba+ad*bc;out[3]=ac*bb+ad*bd;out[4]=ba*atx+bc*aty+btx;out[5]=bb*atx+bd*aty+bty;return out};mat2d.mul=mat2d.multiply;mat2d.rotate=function(out,a,rad){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],st=Math.sin(rad),ct=Math.cos(rad);out[0]=aa*ct+ab*st;out[1]=-aa*st+ab*ct;out[2]=ac*ct+ad*st;out[3]=-ac*st+ct*ad;out[4]=ct*atx+st*aty;out[5]=ct*aty-st*atx;return out};mat2d.scale=function(out,a,v){var vx=v[0],vy=v[1];out[0]=a[0]*vx;out[1]=a[1]*vy;out[2]=a[2]*vx;out[3]=a[3]*vy;out[4]=a[4]*vx;out[5]=a[5]*vy;return out};mat2d.translate=function(out,a,v){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4]+v[0];out[5]=a[5]+v[1];return out};mat2d.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};if(typeof exports!=="undefined"){exports.mat2d=mat2d}var mat3={};var mat3Identity=new Float32Array([1,0,0,0,1,0,0,0,1]);mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(out,a,v){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(out,a,rad){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(out,a,v){var x=v[0],y=v[2];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromMat2d=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=xy-wz;out[4]=1-(xx+zz);out[5]=yz+wx;out[6]=xz+wy;out[7]=yz-wx;out[8]=1-(xx+yy);return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};if(typeof exports!=="undefined"){exports.mat3=mat3}var mat4={};var mat4Identity=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;
out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON){return mat4.identity(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};if(typeof exports!=="undefined"){exports.mat4=mat4}var quat={};var quatIdentity=new Float32Array([0,0,0,1]);quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(out,axis,rad){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=aw*bw-ax*bx;return out};quat.rotateY=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(out,a){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=z;out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var cosHalfTheta=ax*bx+ay*by+az*bz+aw*bw,halfTheta,sinHalfTheta,ratioA,ratioB;if(Math.abs(cosHalfTheta)>=1){if(out!==a){out[0]=ax;out[1]=ay;out[2]=az;out[3]=aw}return out}halfTheta=Math.acos(cosHalfTheta);sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001){out[0]=ax*.5+bx*.5;out[1]=ay*.5+by*.5;out[2]=az*.5+bz*.5;out[3]=aw*.5+bw*.5;return out}ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta;ratioB=Math.sin(t*halfTheta)/sinHalfTheta;out[0]=ax*ratioA+bx*ratioB;out[1]=ay*ratioA+by*ratioB;out[2]=az*ratioA+bz*ratioB;out[3]=aw*ratioA+bw*ratioB;return out};quat.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;quat.fromMat3=function(){var s_iNext=[1,2,0];return function(out,m){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[7]-m[5])*fRoot;out[1]=(m[2]-m[6])*fRoot;out[2]=(m[3]-m[1])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=s_iNext[i];var k=s_iNext[j];fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[k*3+j]-m[j*3+k])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out}}();quat.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.quat=quat}})(shim.exports)})()},{}],18:[function(_dereq_,module,exports){module.exports=_dereq_(13)},{IMmnkj:21}],19:[function(_dereq_,module,exports){(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.6.0";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return obj;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,length=obj.length;i<length;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){if(iterator.call(context,obj[keys[i]],keys[i],obj)===breaker)return}}return obj};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results.push(iterator.call(context,value,index,list))});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,predicate,context){var result;any(obj,function(value,index,list){if(predicate.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,predicate,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(predicate,context);each(obj,function(value,index,list){if(predicate.call(context,value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,function(value,index,list){return!predicate.call(context,value,index,list)},context)};_.every=_.all=function(obj,predicate,context){predicate||(predicate=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(predicate,context);each(obj,function(value,index,list){if(!(result=result&&predicate.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,predicate,context){predicate||(predicate=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(predicate,context);each(obj,function(value,index,list){if(result||(result=predicate.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matches(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matches(attrs))};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}var result=-Infinity,lastComputed=-Infinity;each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;if(computed>lastComputed){result=value;lastComputed=computed}});return result};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}var result=Infinity,lastComputed=Infinity;each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;if(computed<lastComputed){result=value;lastComputed=computed}});return result};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(obj.length!==+obj.length)obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};var lookupIterator=function(value){if(value==null)return _.identity;if(_.isFunction(value))return value;return _.property(value)};_.sortBy=function(obj,iterator,context){iterator=lookupIterator(iterator);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iterator,context){var result={};iterator=lookupIterator(iterator);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result}};_.groupBy=group(function(result,key,value){_.has(result,key)?result[key].push(value):result[key]=[value]});_.indexBy=group(function(result,key,value){result[key]=value});_.countBy=group(function(result,key){_.has(result,key)?result[key]++:result[key]=1});_.sortedIndex=function(array,obj,iterator,context){iterator=lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];if(n<0)return[];return slice.call(array,0,n)};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return slice.call(array,Math.max(array.length-n,0))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){if(shallow&&_.every(input,_.isArray)){return concat.apply(output,input)}each(input,function(value){if(_.isArray(value)||_.isArguments(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.partition=function(array,predicate){var pass=[],fail=[];each(array,function(elem){(predicate(elem)?pass:fail).push(elem)});return[pass,fail]};_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(_.flatten(arguments,true))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.contains(other,item)})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var length=_.max(_.pluck(arguments,"length").concat(0));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(arguments,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,length=list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,length=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var length=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(length);while(idx<length){range[idx++]=start;start+=step}return range};var ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError;args=slice.call(arguments,2);return bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));ctor.prototype=func.prototype;var self=new ctor;ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));if(Object(result)===result)return result;return self}};_.partial=function(func){var boundArgs=slice.call(arguments,1);return function(){var position=0;var args=boundArgs.slice();for(var i=0,length=args.length;i<length;i++){if(args[i]===_)args[i]=arguments[position++]}while(position<arguments.length)args.push(arguments[position++]);return func.apply(this,args)}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)throw new Error("bindAll must be passed function names");each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;options||(options={});var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout){timeout=setTimeout(later,wait)}if(callNow){result=func.apply(context,args);context=args=null}return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=new Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=new Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop]}}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]===void 0)obj[prop]=source[prop]}}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.property=function(key){return function(obj){return obj[key]}};_.matches=function(attrs){return function(obj){if(obj===attrs)return true;for(var key in attrs){if(attrs[key]!==obj[key])return false}return true}};_.times=function(n,iterator,context){var accum=Array(Math.max(0,n));for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return void 0;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}if(evaluate){source+="';\n"+evaluate+"\n__p+='"}index=offset+match.length;return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}});if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this)},{}],20:[function(_dereq_,module,exports){},{}],21:[function(_dereq_,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}]},{},[11])(11)});